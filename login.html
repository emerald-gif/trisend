<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Log In · Trisend</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<style>
:root{
  --primary:#F97316;--pl:#FFF7ED;--border:#E2E8F0;
  --bg:#F8FAFC;--bg2:#fff;--bg3:#F1F5F9;
  --text:#0F172A;--text2:#475569;--text3:#94A3B8;
  --red:#EF4444;--rl:#FEF2F2;
  --grad:linear-gradient(135deg,#F97316,#EF4444);
  --gradb:linear-gradient(135deg,#3B82F6,#6366F1);
  --r:12px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#FFF7ED 0%,#fff 50%,#EFF6FF 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;-webkit-font-smoothing:antialiased;}
.card{background:var(--bg2);border:1.5px solid var(--border);border-radius:20px;padding:40px;width:100%;max-width:420px;box-shadow:0 8px 40px rgba(0,0,0,.08);}
.logo{display:flex;align-items:center;gap:10px;font-size:20px;font-weight:900;color:var(--text);margin-bottom:30px;text-decoration:none;}
.logo-mark{width:38px;height:38px;border-radius:11px;background:var(--grad);display:flex;align-items:center;justify-content:center;}
h1{font-size:24px;font-weight:800;margin-bottom:4px;}
.sub{font-size:14px;color:var(--text2);margin-bottom:28px;}
.fg{margin-bottom:16px;}
label{display:block;font-size:12px;font-weight:700;color:var(--text2);margin-bottom:6px;}
input{width:100%;padding:11px 14px;background:var(--bg3);border:1.5px solid var(--border);border-radius:var(--r);color:var(--text);font-family:'Inter',sans-serif;font-size:14px;outline:none;transition:.18s;}
input:focus{border-color:var(--primary);background:var(--bg2);box-shadow:0 0 0 3px rgba(249,115,22,.1);}
input::placeholder{color:var(--text3);}
input:disabled{opacity:.5;cursor:not-allowed;}
.pass-wrap{position:relative;}
.pass-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--text3);padding:4px;display:flex;}
.pass-toggle:hover{color:var(--text);}
.btn{width:100%;padding:13px;border:none;border-radius:var(--r);font-family:'Inter',sans-serif;font-size:14px;font-weight:700;cursor:pointer;transition:all .18s;display:flex;align-items:center;justify-content:center;gap:8px;}
.btn:disabled{opacity:.5;cursor:not-allowed;}
.btn-primary{background:var(--grad);color:#fff;box-shadow:0 2px 12px rgba(249,115,22,.3);margin-bottom:12px;}
.btn-primary:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 20px rgba(249,115,22,.45);}
.btn-google{background:var(--bg3);color:var(--text);border:1.5px solid var(--border);}
.btn-google:hover:not(:disabled){background:#E2E8F0;}
.divider{display:flex;align-items:center;gap:10px;margin:16px 0;color:var(--text3);font-size:12px;font-weight:500;}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border);}
.footer{text-align:center;margin-top:20px;font-size:13px;color:var(--text2);}
.footer a{color:var(--primary);font-weight:600;text-decoration:none;}
.footer a:hover{text-decoration:underline;}
.err-box{background:var(--rl);border:1.5px solid #FECACA;border-radius:var(--r);padding:10px 14px;font-size:13px;color:var(--red);margin-bottom:14px;display:none;}

/* Toast */
#toastWrap{position:fixed;top:18px;right:18px;z-index:9999;display:flex;flex-direction:column;gap:8px;max-width:300px;}
.toast{padding:11px 14px;border-radius:10px;font-size:13px;font-weight:500;display:flex;align-items:center;gap:9px;animation:tIn .22s ease;box-shadow:0 4px 16px rgba(0,0,0,.1);border:1.5px solid;}
.toast.ok{background:#ECFDF5;border-color:#A7F3D0;color:#065F46;}
.toast.err{background:#FEF2F2;border-color:#FECACA;color:#991B1B;}
.toast.inf{background:#EFF6FF;border-color:#BFDBFE;color:#1E40AF;}
@keyframes tIn{from{opacity:0;transform:translateX(16px);}to{opacity:1;transform:translateX(0);}}

.spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.4);border-top-color:#fff;border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>
<body>
<div id="toastWrap"></div>

<div class="card">
  <a class="logo" href="/">
    <div class="logo-mark">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
        <rect x="1" y="1" width="8" height="8" rx="1.5" fill="white"/>
        <rect x="3.5" y="3.5" width="3" height="3" fill="#F97316"/>
        <rect x="15" y="1" width="8" height="8" rx="1.5" fill="white"/>
        <rect x="17.5" y="3.5" width="3" height="3" fill="#F97316"/>
        <rect x="1" y="15" width="8" height="8" rx="1.5" fill="white"/>
        <rect x="3.5" y="17.5" width="3" height="3" fill="#F97316"/>
      </svg>
    </div>
    Trisend
  </a>
  <h1>Welcome back</h1>
  <p class="sub">Log in to your account to continue.</p>

  <div class="err-box" id="errBox"></div>

  <div class="fg">
    <label for="email">Email Address</label>
    <input id="email" type="email" placeholder="you@example.com" autocomplete="email" autofocus>
  </div>
  <div class="fg">
    <label for="password">Password</label>
    <div class="pass-wrap">
      <input id="password" type="password" placeholder="Enter your password" autocomplete="current-password">
      <button class="pass-toggle" onclick="togglePass()" type="button" tabindex="-1">
        <svg id="eyeIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
      </button>
    </div>
  </div>

  <button class="btn btn-primary" id="loginBtn" onclick="doLogin()">
    Log In
  </button>

  <div class="divider">or continue with</div>

  <button class="btn btn-google" id="googleBtn" onclick="doGoogle()">
    <svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.34-8.16 2.34-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
    Continue with Google
  </button>

  <div class="footer">
    Don't have an account? <a href="/signup">Sign up free</a>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCgaYVSaKtXAQOVRTRfAGV6cWjPqG9x4Tc",
  authDomain: "trisend-e7250.firebaseapp.com",
  projectId: "trisend-e7250",
  storageBucket: "trisend-e7250.firebasestorage.app",
  messagingSenderId: "1088068014414",
  appId: "1:1088068014414:web:77c1f5c1de544b6ab5ce1f"
});
const auth = firebase.auth();
const db   = firebase.firestore();

const AUTH_ERRORS = {
  'auth/user-not-found':    'No account found with that email.',
  'auth/wrong-password':    'Incorrect password. Try again.',
  'auth/invalid-credential':'Invalid email or password.',
  'auth/email-already-in-use': 'That email is already registered.',
  'auth/weak-password':     'Password must be at least 8 characters.',
  'auth/invalid-email':     'Please enter a valid email address.',
  'auth/too-many-requests': 'Too many attempts. Please wait a moment.',
  'auth/network-request-failed': 'Network error. Check your connection.',
  'auth/popup-closed-by-user': 'Google sign-in was cancelled.',
};
function friendlyErr(code) {
  return AUTH_ERRORS[code] || 'Something went wrong. Please try again.';
}

function toast(msg, type = 'inf') {
  const d = document.createElement('div');
  d.className = `toast ${type}`;
  d.textContent = msg;
  document.getElementById('toastWrap').appendChild(d);
  setTimeout(() => d.remove(), 4000);
}

function showErr(msg) {
  const box = document.getElementById('errBox');
  box.textContent = msg;
  box.style.display = 'block';
}
function hideErr() {
  document.getElementById('errBox').style.display = 'none';
}

function setLoading(loading) {
  const btn = document.getElementById('loginBtn');
  const gBtn = document.getElementById('googleBtn');
  btn.disabled = gBtn.disabled = loading;
  if (loading) {
    btn.innerHTML = '<div class="spinner"></div> Logging in…';
  } else {
    btn.innerHTML = 'Log In';
  }
  document.getElementById('email').disabled = loading;
  document.getElementById('password').disabled = loading;
}

function togglePass() {
  const inp = document.getElementById('password');
  inp.type = inp.type === 'password' ? 'text' : 'password';
}

// Enter key submits
document.addEventListener('keydown', e => {
  if (e.key === 'Enter') doLogin();
});

async function doLogin() {
  hideErr();
  const email = document.getElementById('email').value.trim();
  const pass  = document.getElementById('password').value;
  if (!email) { showErr('Please enter your email address.'); return; }
  if (!pass)  { showErr('Please enter your password.'); return; }

  setLoading(true);
  try {
    await auth.signInWithEmailAndPassword(email, pass);
    // onAuthStateChanged will redirect
  } catch (err) {
    showErr(friendlyErr(err.code));
    setLoading(false);
  }
}

async function doGoogle() {
  hideErr();
  const gBtn = document.getElementById('googleBtn');
  gBtn.disabled = true;
  gBtn.innerHTML = '<div class="spinner" style="border-color:rgba(0,0,0,.2);border-top-color:var(--text);"></div> Connecting…';
  try {
    const prov = new firebase.auth.GoogleAuthProvider();
    const cred = await auth.signInWithPopup(prov);
    // Create user doc if new
    const snap = await db.collection('users').doc(cred.user.uid).get();
    if (!snap.exists) {
      await db.collection('users').doc(cred.user.uid).set({
        displayName: cred.user.displayName || 'User',
        email: cred.user.email,
        photoURL: cred.user.photoURL || '',
        plan: 'free', role: 'user',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        qrCount: 0, linkCount: 0,
      });
    }
    // onAuthStateChanged handles redirect
  } catch (err) {
    showErr(friendlyErr(err.code));
    gBtn.disabled = false;
    gBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.34-8.16 2.34-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg> Continue with Google`;
  }
}

auth.onAuthStateChanged(async user => {
  if (user) {
    try {
      const snap = await db.collection('users').doc(user.uid).get();
      const ud = snap.data() || {};
      if (ud.role === 'admin') {
        window.location.href = '/dashboard?admin=1';
      } else {
        window.location.href = '/dashboard';
      }
    } catch {
      window.location.href = '/dashboard';
    }
  }
});
</script>
</body>
</html>
