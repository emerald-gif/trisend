<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<title>Dashboard - Trisend</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script src="https://js.paystack.co/v1/inline.js"></script>
<style>
:root{
  --bg:#F8FAFC;--bg2:#fff;--bg3:#F1F5F9;--bg4:#E2E8F0;
  --border:#E2E8F0;--border2:#CBD5E1;
  --primary:#F97316;--pl:#FFF7ED;--plb:#FDBA74;
  --blue:#3B82F6;--bl:#EFF6FF;
  --green:#10B981;--gl:#ECFDF5;
  --red:#EF4444;--rl:#FEF2F2;
  --yellow:#F59E0B;--purple:#7C3AED;--pul:#F5F3FF;
  --silver:#94A3B8;
  --text:#0F172A;--text2:#475569;--text3:#94A3B8;
  --grad:linear-gradient(135deg,#F97316 0%,#EF4444 100%);
  --gradb:linear-gradient(135deg,#3B82F6 0%,#6366F1 100%);
  --gradg:linear-gradient(135deg,#10B981,#059669);
  --shadow:0 1px 4px rgba(0,0,0,.06);
  --shadowm:0 4px 20px rgba(0,0,0,.08);
  --r:14px;--r2:10px;--r3:8px;--sidebar:260px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;-webkit-font-smoothing:antialiased;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px;}
.hidden{display:none!important;}
#toastWrap{position:fixed;top:18px;right:18px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none;max-width:320px;}
.toast{padding:12px 16px;border-radius:10px;font-size:13px;font-weight:500;display:flex;align-items:flex-start;gap:10px;pointer-events:all;animation:tIn .25s ease;box-shadow:var(--shadowm);border:1.5px solid;line-height:1.4;}
.toast.ok{background:#ECFDF5;border-color:#A7F3D0;color:#065F46;}
.toast.err{background:#FEF2F2;border-color:#FECACA;color:#991B1B;}
.toast.inf{background:#EFF6FF;border-color:#BFDBFE;color:#1E40AF;}
@keyframes tIn{from{opacity:0;transform:translateX(16px);}to{opacity:1;transform:translateX(0);}}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;padding:10px 18px;border-radius:var(--r3);border:none;cursor:pointer;font-family:'Inter',sans-serif;font-weight:600;font-size:13px;transition:all .18s;white-space:nowrap;text-decoration:none;}
.btn:disabled{opacity:.5;cursor:not-allowed;}
.btn-primary{background:var(--grad);color:#fff;box-shadow:0 2px 8px rgba(249,115,22,.25);}
.btn-primary:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 16px rgba(249,115,22,.4);}
.btn-ghost{background:transparent;color:var(--text2);border:1.5px solid var(--border2);}
.btn-ghost:hover{background:var(--bg3);color:var(--text);}
.btn-so{background:var(--pl);color:var(--primary);border:1.5px solid rgba(249,115,22,.2);}
.btn-sr{background:var(--rl);color:var(--red);border:1.5px solid rgba(239,68,68,.2);}
.btn-sg{background:var(--gl);color:var(--green);border:1.5px solid rgba(16,185,129,.2);}
.btn-sb{background:var(--bl);color:var(--blue);border:1.5px solid rgba(59,130,246,.2);}
.btn-sm{padding:6px 12px;font-size:12px;}
.btn-lg{padding:13px 26px;font-size:15px;border-radius:var(--r2);}
.btn-full{width:100%;}
.fg{margin-bottom:14px;}
.flabel{display:block;font-size:12px;font-weight:700;color:var(--text2);margin-bottom:6px;}
.finput{width:100%;padding:10px 13px;background:var(--bg3);border:1.5px solid var(--border);border-radius:var(--r3);color:var(--text);font-family:'Inter',sans-serif;font-size:14px;outline:none;transition:.18s;}
.finput:focus{border-color:var(--primary);background:var(--bg2);box-shadow:0 0 0 3px rgba(249,115,22,.1);}
.finput::placeholder{color:var(--text3);}
.finput:disabled{opacity:.55;cursor:not-allowed;}
select.finput{cursor:pointer;}
textarea.finput{resize:vertical;min-height:80px;}
.frow{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.card{background:var(--bg2);border:1.5px solid var(--border);border-radius:var(--r);padding:20px;box-shadow:var(--shadow);}
.card-title{font-size:15px;font-weight:700;color:var(--text);}
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:50px;font-size:11px;font-weight:700;}
.bo{background:var(--pl);color:var(--primary);}
.bb{background:var(--bl);color:var(--blue);}
.bg_{background:var(--gl);color:var(--green);}
.br{background:var(--rl);color:var(--red);}
.bs{background:var(--bg3);color:var(--text3);}
.sec-label{font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--text3);margin-bottom:8px;}
/* SIDEBAR */
.sidebar{width:var(--sidebar);min-height:100vh;background:var(--bg2);border-right:1.5px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;z-index:50;transition:transform .28s cubic-bezier(.4,0,.2,1);}
.soverlay{display:none;position:fixed;inset:0;background:rgba(15,23,42,.4);z-index:49;}
.s-header{padding:16px 14px;border-bottom:1.5px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.logo{display:flex;align-items:center;gap:9px;font-size:18px;font-weight:900;letter-spacing:-.4px;color:var(--text);text-decoration:none;}
.logo-mark{width:32px;height:32px;border-radius:9px;background:var(--grad);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.sclose-btn{display:none;background:var(--bg3);border:none;width:28px;height:28px;border-radius:7px;align-items:center;justify-content:center;cursor:pointer;color:var(--text2);}
.s-user{padding:13px 14px;border-bottom:1.5px solid var(--border);}
.s-user-row{display:flex;align-items:center;gap:10px;}
.av{width:38px;height:38px;border-radius:50%;background:var(--grad);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;color:#fff;flex-shrink:0;overflow:hidden;}
.av img{width:100%;height:100%;object-fit:cover;}
.u-info{min-width:0;flex:1;}
.u-name{font-size:13.5px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.u-email{font-size:11px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:1px;}
.plan-pill{display:inline-flex;align-items:center;gap:3px;margin-top:4px;padding:2px 8px;border-radius:50px;font-size:9.5px;font-weight:700;letter-spacing:.4px;text-transform:uppercase;}
.pill-free{background:var(--bg3);color:var(--silver);}
.pill-premium{background:var(--grad);color:#fff;}
.s-nav{flex:1;padding:8px;overflow-y:auto;}
.ni{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:var(--r3);color:var(--text2);cursor:pointer;font-size:13px;font-weight:500;transition:.15s;margin-bottom:2px;user-select:none;}
.ni:hover{background:var(--bg3);color:var(--text);}
.ni.active{background:var(--pl);color:var(--primary);font-weight:600;}
.ni .ni-ic{width:20px;flex-shrink:0;}
.ni .ni-badge{margin-left:auto;background:var(--primary);color:#fff;font-size:9px;font-weight:700;padding:2px 6px;border-radius:50px;}
.ni-sep{height:1px;background:var(--border);margin:6px 2px;}
.s-bot{padding:8px;border-top:1.5px solid var(--border);}
.dash-main{margin-left:var(--sidebar);flex:1;display:flex;flex-direction:column;min-height:100vh;}
.topbar{position:sticky;top:0;z-index:40;height:58px;padding:0 22px;background:rgba(255,255,255,.97);backdrop-filter:blur(20px);border-bottom:1.5px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.tb-left{display:flex;align-items:center;gap:10px;}
.hamburger{display:none;background:var(--bg3);border:none;width:34px;height:34px;border-radius:var(--r3);align-items:center;justify-content:center;cursor:pointer;color:var(--text2);}
.tb-title{font-size:15px;font-weight:700;}
.tb-right{display:flex;align-items:center;gap:8px;}
.notif-btn{position:relative;width:36px;height:36px;background:var(--bg3);border:1.5px solid var(--border);border-radius:var(--r3);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text2);transition:.15s;}
.notif-btn:hover{background:var(--border);}
.ndot{position:absolute;top:6px;right:6px;width:8px;height:8px;background:var(--primary);border-radius:50%;border:2px solid var(--bg2);}
.d-content{flex:1;padding:22px;}
.panel{display:none;animation:fUp .22s ease;}
.panel.active{display:block;}
@keyframes fUp{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:20px;}
.sc{background:var(--bg2);border:1.5px solid var(--border);border-radius:var(--r2);padding:16px;box-shadow:var(--shadow);transition:.2s;}
.sc:hover{transform:translateY(-2px);box-shadow:var(--shadowm);}
.sc-ico{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;margin-bottom:10px;}
.sc-val{font-size:26px;font-weight:900;margin-bottom:2px;letter-spacing:-.5px;}
.sc-label{font-size:12px;color:var(--text2);font-weight:500;}
.up-strip{background:linear-gradient(135deg,#FFF7ED,#FEF3C7);border:1.5px solid rgba(249,115,22,.25);border-radius:var(--r2);padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:14px;margin-bottom:20px;flex-wrap:wrap;}
.twocol{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
.lcard{background:var(--bg2);border:1.5px solid var(--border);border-radius:var(--r2);padding:14px;margin-bottom:10px;transition:.18s;}
.lcard:hover{border-color:var(--border2);box-shadow:var(--shadow);}
.lcard h4{font-size:13px;font-weight:600;margin-bottom:5px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.lcard .lshort{font-size:12px;color:var(--primary);font-weight:600;margin-bottom:6px;}
.lcard .lmeta{font-size:11.5px;color:var(--text3);display:flex;gap:12px;flex-wrap:wrap;}
.lcard .lactions{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;}
.lexp{font-size:10.5px;padding:2px 8px;border-radius:50px;font-weight:700;}
.lexp.expired{background:var(--rl);color:var(--red);}
.lexp.active{background:var(--gl);color:var(--green);}
.lexp.limited{background:var(--bl);color:var(--blue);}
.qr-types{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px;}
.qt{padding:7px 14px;border-radius:6px;border:1.5px solid var(--border);background:var(--bg3);font-size:12px;font-weight:600;cursor:pointer;transition:.15s;color:var(--text2);}
.qt:hover,.qt.active{background:var(--pl);border-color:var(--primary);color:var(--primary);}
.lock-overlay{position:relative;}
.lock-overlay.locked::after{content:'';position:absolute;inset:0;background:rgba(248,250,252,.75);border-radius:var(--r3);z-index:1;backdrop-filter:blur(2px);}
.lock-overlay.locked .lock-label{display:flex;}
.lock-label{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:2;background:var(--grad);color:#fff;padding:6px 14px;border-radius:50px;font-size:11px;font-weight:700;white-space:nowrap;box-shadow:var(--shadowm);cursor:pointer;}
.qr-preview-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:220px;border:2px dashed var(--border2);border-radius:var(--r2);padding:20px;background:var(--bg3);position:relative;margin-bottom:12px;transition:.2s;}
.qr-preview-wrap.has-qr{border-style:solid;border-color:var(--border);background:var(--bg2);}
.qr-empty{text-align:center;color:var(--text3);}
.qr-empty p{font-size:13px;margin-top:8px;}
.frame-opts{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:14px;}
.fopt{padding:8px 6px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg3);cursor:pointer;text-align:center;font-size:10.5px;font-weight:600;color:var(--text2);transition:.15s;}
.fopt:hover,.fopt.active{border-color:var(--primary);background:var(--pl);color:var(--primary);}
.fopt .fo-icon{font-size:18px;display:block;margin-bottom:3px;}
.shape-opts{display:flex;gap:8px;margin-bottom:14px;}
.sopt{flex:1;padding:9px 6px;border-radius:8px;border:1.5px solid var(--border);background:var(--bg3);cursor:pointer;text-align:center;font-size:11px;font-weight:600;color:var(--text2);transition:.15s;}
.sopt:hover,.sopt.active{border-color:var(--primary);background:var(--pl);color:var(--primary);}
.a-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px;}
.dev-row{display:flex;flex-direction:column;gap:8px;}
.dev-item{display:grid;grid-template-columns:80px 1fr 36px;align-items:center;gap:8px;font-size:12.5px;}
.dev-track{background:var(--bg3);border-radius:50px;height:7px;overflow:hidden;}
.dev-fill{height:100%;border-radius:50px;transition:width 1s ease;}
.citem{display:flex;align-items:center;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--bg3);font-size:13px;}
.citem:last-child{border:none;}
.chart-bar-wrap{display:flex;align-items:flex-end;gap:4px;height:100px;padding-top:10px;}
.chart-bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;}
.chart-bar{width:100%;border-radius:4px 4px 0 0;min-height:2px;}
.chart-lbl{font-size:9px;color:var(--text3);}
.ncard{display:flex;gap:12px;padding:13px;border-radius:var(--r2);border:1.5px solid var(--border);cursor:pointer;transition:.15s;margin-bottom:8px;}
.ncard:hover{background:var(--bg3);}
.ncard.unread{border-color:rgba(249,115,22,.3);background:var(--pl);}
.ndotc{width:9px;height:9px;border-radius:50%;background:var(--border2);flex-shrink:0;margin-top:4px;}
.ndotc.unread{background:var(--primary);}
.ncard h4{font-size:13px;font-weight:600;margin-bottom:3px;}
.ncard p{font-size:12.5px;color:var(--text2);line-height:1.5;}
.ntime{font-size:11px;color:var(--text3);margin-top:5px;}
.chat-wrap{display:flex;flex-direction:column;height:calc(100vh - 180px);min-height:400px;}
.chat-msgs{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;}
.chat-bubble{max-width:80%;padding:10px 14px;border-radius:12px;font-size:13.5px;line-height:1.55;}
.chat-bubble.user{align-self:flex-end;background:var(--grad);color:#fff;border-bottom-right-radius:4px;}
.chat-bubble.bot{align-self:flex-start;background:var(--bg3);color:var(--text);border-bottom-left-radius:4px;}
.chat-input-row{display:flex;gap:8px;padding:12px;border-top:1.5px solid var(--border);}
.chat-input-row input{flex:1;padding:10px 14px;border:1.5px solid var(--border);border-radius:20px;font-family:'Inter',sans-serif;font-size:13px;outline:none;background:var(--bg3);}
.chat-input-row input:focus{border-color:var(--primary);background:var(--bg2);}
.up-hero{text-align:center;padding:24px 0;}
.up-price{font-size:52px;font-weight:900;letter-spacing:-2px;margin:12px 0;}
.up-feats{background:var(--bg2);border:1.5px solid var(--border);border-radius:var(--r);padding:20px;margin:18px 0;display:grid;grid-template-columns:1fr 1fr;gap:9px;}
.uf-item{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text2);}
.empty-s{text-align:center;padding:44px 20px;color:var(--text3);}
.empty-s p{font-size:13px;margin-top:10px;}
.twrap{background:var(--bg2);border:1.5px solid var(--border);border-radius:var(--r);overflow:auto;}
table{width:100%;border-collapse:collapse;min-width:480px;}
thead tr{background:var(--bg3);}
th{padding:10px 14px;text-align:left;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);border-bottom:1.5px solid var(--border);}
td{padding:10px 14px;font-size:13px;border-bottom:1px solid var(--bg3);}
tr:last-child td{border:none;}
tr:hover td{background:#FAFBFD;}
.act-item{display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--bg3);}
.act-item:last-child{border:none;}
.act-ico{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:15px;}
.act-info{flex:1;min-width:0;}
.act-title{font-size:13px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.act-sub{font-size:11px;color:var(--text3);margin-top:1px;}
.act-time{font-size:11px;color:var(--text3);}
.quick-actions{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;}
.qa{display:flex;align-items:center;gap:11px;padding:14px;border:1.5px solid var(--border);border-radius:var(--r2);cursor:pointer;transition:.18s;background:var(--bg2);}
.qa:hover{border-color:var(--primary);background:var(--pl);transform:translateY(-2px);box-shadow:var(--shadow);}
.qa-ico{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:18px;}
.qa-label{font-size:13px;font-weight:700;}
.qa-sub{font-size:11px;color:var(--text2);margin-top:1px;}
.asidebar{width:220px;min-height:100vh;background:var(--bg2);border-right:1.5px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;z-index:50;}
.amain{margin-left:220px;flex:1;}
.atopbar{height:58px;padding:0 22px;background:rgba(255,255,255,.97);border-bottom:1.5px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:40;}
.acontent{padding:22px;}
.apanel{display:none;animation:fUp .22s ease;}
.apanel.active{display:block;}
@keyframes spin{to{transform:rotate(360deg);}}
@media(max-width:900px){.twocol{grid-template-columns:1fr;}.frow{grid-template-columns:1fr;}.up-feats{grid-template-columns:1fr;}.asidebar{display:none;}.amain{margin-left:0;}}
@media(max-width:768px){.sidebar{transform:translateX(-100%);}.sidebar.open{transform:translateX(0);}.soverlay.show{display:block;}.sclose-btn{display:flex;}.hamburger{display:flex;}.dash-main{margin-left:0;}.d-content{padding:14px;}.stats-row{grid-template-columns:1fr 1fr;}.quick-actions{grid-template-columns:1fr 1fr;}}
@media(max-width:480px){.frame-opts{grid-template-columns:repeat(3,1fr);}.quick-actions{grid-template-columns:1fr;}}
</style>
</head>
<body>
<div id="toastWrap"></div>
<div id="dashboard" style="display:flex;min-height:100vh;">
<div class="soverlay" id="soverlay" onclick="toggleSidebar(false)"></div>
<aside class="sidebar" id="sidebar">
  <div class="s-header">
    <a class="logo" href="/">
      <div class="logo-mark">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <rect x="1" y="1" width="8" height="8" rx="1.5" fill="white"/>
          <rect x="3.5" y="3.5" width="3" height="3" fill="#F97316"/>
          <rect x="15" y="1" width="8" height="8" rx="1.5" fill="white"/>
          <rect x="17.5" y="3.5" width="3" height="3" fill="#F97316"/>
          <rect x="1" y="15" width="8" height="8" rx="1.5" fill="white"/>
          <rect x="3.5" y="17.5" width="3" height="3" fill="#F97316"/>
          <rect x="15" y="15" width="3" height="3" rx=".5" fill="white"/>
          <rect x="20" y="20" width="3" height="3" rx=".5" fill="white"/>
        </svg>
      </div>Trisend
    </a>
    <button class="sclose-btn" onclick="toggleSidebar(false)">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
  </div>
  <div class="s-user">
    <div class="s-user-row">
      <div class="av" id="sAv">U</div>
      <div class="u-info">
        <div class="u-name" id="sUserName">Loading...</div>
        <div class="u-email" id="sUserEmail"></div>
        <div class="plan-pill pill-free" id="sPlan">Free</div>
      </div>
    </div>
  </div>
  <nav class="s-nav">
    <div class="sec-label" style="padding:0 4px;margin-top:6px;">Main</div>
    <div class="ni active" data-p="home" onclick="showPanel('home')"><span class="ni-ic">&#x1F3E0;</span> Dashboard</div>
    <div class="ni" data-p="qr" onclick="showPanel('qr')"><span class="ni-ic">&#x1F532;</span> QR Generator</div>
    <div class="ni" data-p="links" onclick="showPanel('links')"><span class="ni-ic">&#x1F517;</span> Short Links</div>
    <div class="ni" data-p="analytics" onclick="showPanel('analytics')"><span class="ni-ic">&#x1F4CA;</span> Analytics</div>
    <div class="ni-sep"></div>
    <div class="sec-label" style="padding:0 4px;">More</div>
    <div class="ni" data-p="notifications" onclick="showPanel('notifications')"><span class="ni-ic">&#x1F514;</span> Notifications<span class="ni-badge hidden" id="nBadge">0</span></div>
    <div class="ni" data-p="chat" onclick="showPanel('chat')"><span class="ni-ic">&#x1F916;</span> AI Assistant</div>
    <div class="ni" data-p="settings" onclick="showPanel('settings')"><span class="ni-ic">&#x2699;&#xFE0F;</span> Settings</div>
    <div class="ni hidden" data-p="upgrade" id="upgradeNav" onclick="showPanel('upgrade')"><span class="ni-ic">&#x2B50;</span> Upgrade Premium</div>
    <div class="ni hidden" id="adminNavItem" onclick="goAdmin()"><span class="ni-ic">&#x1F6E1;&#xFE0F;</span> Admin Panel</div>
  </nav>
  <div class="s-bot">
    <div class="ni" onclick="doLogout()" style="color:var(--red);"><span class="ni-ic">&#x1F6AA;</span> Log Out</div>
  </div>
</aside>
<main class="dash-main">
  <div class="topbar">
    <div class="tb-left">
      <button class="hamburger" onclick="toggleSidebar(true)">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
          <line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/>
        </svg>
      </button>
      <span class="tb-title" id="tbTitle">Dashboard</span>
    </div>
    <div class="tb-right">
      <button class="notif-btn" onclick="showPanel('notifications')" id="notifBell">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 01-3.46 0"/>
        </svg>
      </button>
      <div class="av" id="tbAvatar" style="width:34px;height:34px;font-size:13px;">U</div>
    </div>
  </div>
  <div class="d-content">
    <!-- HOME -->
    <div class="panel active" id="panel-home">
      <div class="up-strip" id="upStrip">
        <div><div style="font-size:14px;font-weight:700;">&#x2B50; Unlock Premium Features</div><div style="font-size:12px;color:var(--text2);margin-top:2px;">Unlimited QR codes, custom branding, link controls &amp; advanced analytics</div></div>
        <button class="btn btn-primary" onclick="showPanel('upgrade')">Upgrade &#x2014; &#x20A6;2,000</button>
      </div>
      <div style="margin-bottom:20px;">
        <h2 style="font-size:20px;font-weight:800;" id="welcomeMsg">Welcome back!</h2>
        <p style="font-size:13.5px;color:var(--text2);margin-top:3px;">Here's your Trisend overview</p>
      </div>
      <div class="stats-row">
        <div class="sc"><div class="sc-ico" style="background:var(--pl);">&#x1F532;</div><div class="sc-val" id="hQR">-</div><div class="sc-label">QR Codes</div></div>
        <div class="sc"><div class="sc-ico" style="background:var(--bl);">&#x1F517;</div><div class="sc-val" id="hLinks">-</div><div class="sc-label">Short Links</div></div>
        <div class="sc"><div class="sc-ico" style="background:var(--gl);">&#x1F4C8;</div><div class="sc-val" id="hClicks">-</div><div class="sc-label">Total Clicks</div></div>
        <div class="sc"><div class="sc-ico" style="background:#F3E8FF;">&#x1F441;&#xFE0F;</div><div class="sc-val" id="hScans">-</div><div class="sc-label">QR Scans</div></div>
      </div>
      <h3 style="font-size:14px;font-weight:700;margin-bottom:12px;">Quick Actions</h3>
      <div class="quick-actions">
        <div class="qa" onclick="showPanel('qr')"><div class="qa-ico" style="background:var(--pl);">&#x1F532;</div><div><div class="qa-label">Generate QR Code</div><div class="qa-sub">URL, WiFi, contact &amp; more</div></div></div>
        <div class="qa" onclick="showPanel('links')"><div class="qa-ico" style="background:var(--bl);">&#x1F517;</div><div><div class="qa-label">Shorten a Link</div><div class="qa-sub">Track every click</div></div></div>
        <div class="qa" onclick="showPanel('analytics')"><div class="qa-ico" style="background:var(--gl);">&#x1F4CA;</div><div><div class="qa-label">View Analytics</div><div class="qa-sub">Clicks, countries, devices</div></div></div>
        <div class="qa" onclick="showPanel('upgrade')"><div class="qa-ico" style="background:var(--pl);">&#x2B50;</div><div><div class="qa-label">Go Premium</div><div class="qa-sub">&#x20A6;2,000 one-time forever</div></div></div>
      </div>
      <div class="twocol">
        <div class="card"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;"><div class="card-title">Recent Activity</div></div><div id="recentAct"><p style="font-size:13px;color:var(--text3);text-align:center;padding:20px 0;">Loading...</p></div></div>
        <div class="card"><div class="card-title" style="margin-bottom:4px;">Clicks (Last 7 Days)</div><p style="font-size:12px;color:var(--text3);margin-bottom:12px;">Real click data from your links</p><div id="homeChart" style="height:100px;"></div></div>
      </div>
      <div class="card" style="margin-top:16px;"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;"><div class="card-title">Recent Links</div><button class="btn btn-ghost btn-sm" onclick="showPanel('links')">View All</button></div><div id="homeLinks"><p style="font-size:13px;color:var(--text3);">Loading...</p></div></div>
    </div>

    <!-- QR GENERATOR -->
    <div class="panel" id="panel-qr">
      <h2 style="font-size:18px;font-weight:800;margin-bottom:4px;">QR Code Generator</h2>
      <p style="font-size:13px;color:var(--text2);margin-bottom:20px;">Configure below, then click Generate QR Code.</p>
      <div class="twocol" style="align-items:start;">
        <div>
          <div class="card" style="margin-bottom:14px;">
            <div class="card-title" style="margin-bottom:12px;">QR Type</div>
            <div class="qr-types">
              <button class="qt active" onclick="setQRType('url',this)">URL</button>
              <button class="qt" onclick="setQRType('text',this)">Text</button>
              <button class="qt" onclick="setQRType('wifi',this)">WiFi</button>
              <button class="qt" onclick="setQRType('contact',this)">vCard</button>
              <button class="qt" onclick="setQRType('email',this)">Email</button>
              <button class="qt" onclick="setQRType('phone',this)">Phone</button>
              <button class="qt" onclick="setQRType('sms',this)">SMS</button>
              <button class="qt" onclick="setQRType('location',this)">Location</button>
            </div>
            <div id="qi-url"><div class="fg"><label class="flabel">Website URL</label><input id="qrURL" class="finput" type="url" placeholder="https://yourwebsite.com"></div></div>
            <div id="qi-text" class="hidden"><div class="fg"><label class="flabel">Text Content</label><textarea id="qrText" class="finput" rows="3" placeholder="Enter any text..."></textarea></div></div>
            <div id="qi-wifi" class="hidden"><div class="fg"><label class="flabel">Network Name (SSID)</label><input id="qrSSID" class="finput" placeholder="MyWiFi"></div><div class="frow"><div class="fg"><label class="flabel">Password</label><input id="qrWPass" class="finput" placeholder="password"></div><div class="fg"><label class="flabel">Security</label><select id="qrWSec" class="finput"><option>WPA</option><option>WEP</option><option value="nopass">None</option></select></div></div></div>
            <div id="qi-contact" class="hidden"><div class="frow"><div class="fg"><label class="flabel">First Name</label><input id="qrCFN" class="finput" placeholder="John"></div><div class="fg"><label class="flabel">Last Name</label><input id="qrCLN" class="finput" placeholder="Doe"></div></div><div class="fg"><label class="flabel">Phone</label><input id="qrCPh" class="finput" placeholder="+234..."></div><div class="fg"><label class="flabel">Email</label><input id="qrCEm" class="finput" placeholder="john@example.com"></div><div class="fg"><label class="flabel">Organisation</label><input id="qrCOrg" class="finput" placeholder="Company Name"></div></div>
            <div id="qi-email" class="hidden"><div class="fg"><label class="flabel">To Address</label><input id="qrETo" class="finput" type="email" placeholder="recipient@example.com"></div><div class="fg"><label class="flabel">Subject</label><input id="qrESub" class="finput" placeholder="Hello!"></div><div class="fg"><label class="flabel">Body</label><textarea id="qrEBody" class="finput" rows="2" placeholder="Email body..."></textarea></div></div>
            <div id="qi-phone" class="hidden"><div class="fg"><label class="flabel">Phone Number</label><input id="qrPhone" class="finput" placeholder="+234 800 000 0000"></div></div>
            <div id="qi-sms" class="hidden"><div class="fg"><label class="flabel">Phone Number</label><input id="qrSPh" class="finput" placeholder="+234 800 000 0000"></div><div class="fg"><label class="flabel">Message</label><textarea id="qrSMsg" class="finput" rows="2" placeholder="Your message..."></textarea></div></div>
            <div id="qi-location" class="hidden"><div class="frow"><div class="fg"><label class="flabel">Latitude</label><input id="qrLat" class="finput" placeholder="6.5244"></div><div class="fg"><label class="flabel">Longitude</label><input id="qrLng" class="finput" placeholder="3.3792"></div></div></div>
          </div>
          <div class="card" style="margin-bottom:14px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;"><div class="card-title">Customisation</div><span class="badge bo">Premium</span></div>
            <div class="lock-overlay locked" id="pfColors">
              <div class="lock-label" onclick="showPanel('upgrade')">Upgrade to unlock</div>
              <div class="fg"><div class="flabel">Colors</div><div style="display:flex;gap:12px;align-items:center;"><label style="display:flex;align-items:center;gap:7px;font-size:12px;font-weight:500;"><input type="color" id="qrFg" value="#000000" disabled style="width:32px;height:32px;border-radius:6px;border:1.5px solid var(--border);cursor:pointer;padding:2px;"> Foreground</label><label style="display:flex;align-items:center;gap:7px;font-size:12px;font-weight:500;"><input type="color" id="qrBg" value="#FFFFFF" disabled style="width:32px;height:32px;border-radius:6px;border:1.5px solid var(--border);cursor:pointer;padding:2px;"> Background</label></div></div>
            </div>
            <div class="frow" style="margin-top:10px;"><div class="fg"><label class="flabel">Size (px)</label><select id="qrSz" class="finput"><option value="200">200px</option><option value="300" selected>300px</option><option value="400">400px</option><option value="500">500px</option></select></div><div class="fg"><label class="flabel">Error Correction</label><select id="qrECC" class="finput"><option value="L">Low (7%)</option><option value="M" selected>Medium (15%)</option><option value="Q">High (25%)</option><option value="H">Max (30%) - Logo safe</option></select></div></div>
            <div class="lock-overlay locked" id="pfShape">
              <div class="lock-label" onclick="showPanel('upgrade')">Upgrade to unlock</div>
              <div class="fg"><div class="flabel">Module Shape</div><div class="shape-opts"><button class="sopt active" onclick="setShape('square',this)">Square</button><button class="sopt" onclick="setShape('dots',this)">Dots</button><button class="sopt" onclick="setShape('rounded',this)">Rounded</button></div></div>
            </div>
            <div class="lock-overlay locked" id="pfFrame">
              <div class="lock-label" onclick="showPanel('upgrade')">Upgrade to unlock</div>
              <div class="fg"><div class="flabel">Scan Frame</div><div class="frame-opts"><button class="fopt active" onclick="setFrame(0,this)"><span class="fo-icon">&#x25FB;</span>None</button><button class="fopt" onclick="setFrame(1,this)"><span class="fo-icon">&#x1F4D0;</span>Corners</button><button class="fopt" onclick="setFrame(2,this)"><span class="fo-icon">&#x1F532;</span>Scan Me</button><button class="fopt" onclick="setFrame(3,this)"><span class="fo-icon">&#x1F4F8;</span>Banner</button><button class="fopt" onclick="setFrame(4,this)"><span class="fo-icon">&#x1F3AF;</span>Target</button></div></div>
            </div>
            <div class="lock-overlay locked" id="pfLogo">
              <div class="lock-label" onclick="showPanel('upgrade')">Upgrade to unlock</div>
              <div class="fg"><label class="flabel">Embed Logo (set ECC to Max first)</label><input type="file" id="qrLogo" class="finput" accept="image/*" disabled style="padding:7px;"></div>
            </div>
          </div>
          <button class="btn btn-primary btn-full btn-lg" onclick="generateQR()" id="genBtn">Generate QR Code</button>
        </div>
        <div style="position:sticky;top:80px;">
          <div class="card">
            <div class="card-title" style="margin-bottom:14px;">Preview</div>
            <div class="qr-preview-wrap" id="qrPreviewWrap">
              <div class="qr-empty" id="qrEmpty">
                <svg width="44" height="44" viewBox="0 0 24 24" fill="none" stroke="#CBD5E1" stroke-width="1.5"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="5" y="5" width="3" height="3" fill="#CBD5E1"/><rect x="16" y="5" width="3" height="3" fill="#CBD5E1"/><rect x="5" y="16" width="3" height="3" fill="#CBD5E1"/></svg>
                <p>Configure settings<br>and click Generate</p>
              </div>
              <canvas id="qrCanvas" style="display:none;max-width:100%;"></canvas>
              <canvas id="qrOutput" style="display:none;max-width:100%;"></canvas>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px;">
              <button class="btn btn-primary btn-full" id="dlBtn" onclick="downloadQR()" disabled>Download PNG</button>
              <button class="btn btn-ghost btn-full" id="saveBtn" onclick="saveQR()" disabled>Save to Account</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- LINKS -->
    <div class="panel" id="panel-links">
      <h2 style="font-size:18px;font-weight:800;margin-bottom:4px;">Short Link Generator</h2>
      <p style="font-size:13px;color:var(--text2);margin-bottom:20px;">Create smart, trackable short links.</p>
      <div class="twocol">
        <div>
          <div class="card" style="margin-bottom:14px;">
            <div class="card-title" style="margin-bottom:14px;">Shorten a Link</div>
            <div class="fg"><label class="flabel">Long URL *</label><input id="longURL" type="url" class="finput" placeholder="https://your-very-long-url.com"></div>
            <div class="lock-overlay locked" id="pfAlias"><div class="lock-label" onclick="showPanel('upgrade')">Premium</div><div class="fg"><label class="flabel">Custom Alias (optional)</label><input id="customAlias" class="finput" placeholder="my-link-name"></div></div>
            <div class="lock-overlay locked" id="pfExpiry" style="margin-top:8px;"><div class="lock-label" onclick="showPanel('upgrade')">Premium</div><div class="frow"><div class="fg"><label class="flabel">Expires On</label><input id="linkExpiry" type="date" class="finput"></div><div class="fg"><label class="flabel">Max Clicks</label><input id="linkMaxClicks" type="number" class="finput" placeholder="e.g. 100" min="1"></div></div></div>
            <div class="lock-overlay locked" id="pfLinkPwd" style="margin-top:8px;"><div class="lock-label" onclick="showPanel('upgrade')">Premium</div><div class="fg"><label class="flabel">Password Protect</label><input id="linkPassword" type="text" class="finput" placeholder="Leave empty for none"></div></div>
            <button class="btn btn-primary btn-full" style="margin-top:12px;" onclick="shortenLink()">Shorten Link</button>
            <div class="card" id="linkResult" style="display:none;margin-top:12px;background:var(--gl);border-color:rgba(16,185,129,.3);">
              <div style="font-size:12px;color:var(--green);font-weight:700;margin-bottom:6px;">Link Created!</div>
              <div style="font-size:14px;font-weight:700;word-break:break-all;margin-bottom:10px;" id="shortLinkTxt"></div>
              <div style="display:flex;gap:6px;flex-wrap:wrap;"><button class="btn btn-sg btn-sm" onclick="copyShortLink()">Copy</button><button class="btn btn-sb btn-sm" onclick="qrFromLink()">Make QR</button></div>
            </div>
          </div>
        </div>
        <div>
          <div class="card"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;"><div class="card-title">My Links</div><span id="linkCount" style="font-size:12px;color:var(--text3);"></span></div><div id="linksList"><div class="empty-s"><p>No links yet. Create your first!</p></div></div></div>
        </div>
      </div>
    </div>

    <!-- ANALYTICS -->
    <div class="panel" id="panel-analytics">
      <div class="a-header"><div><h2 style="font-size:18px;font-weight:800;margin-bottom:4px;">Analytics</h2><p style="font-size:13px;color:var(--text2);">Real-time data from your QR scans and link clicks</p></div><button class="btn btn-ghost btn-sm" onclick="exportCSV()">Export CSV</button></div>
      <div class="stats-row">
        <div class="sc"><div class="sc-ico" style="background:var(--pl);">&#x1F532;</div><div class="sc-val" id="aQR">-</div><div class="sc-label">QR Codes</div></div>
        <div class="sc"><div class="sc-ico" style="background:var(--bl);">&#x1F517;</div><div class="sc-val" id="aLinks">-</div><div class="sc-label">Short Links</div></div>
        <div class="sc"><div class="sc-ico" style="background:var(--gl);">&#x1F4C8;</div><div class="sc-val" id="aClicks">-</div><div class="sc-label">Link Clicks</div></div>
        <div class="sc"><div class="sc-ico" style="background:#F3E8FF;">&#x1F441;&#xFE0F;</div><div class="sc-val" id="aScans">-</div><div class="sc-label">QR Scans</div></div>
      </div>
      <div class="twocol" style="margin-bottom:16px;">
        <div class="card"><div class="card-title" style="margin-bottom:14px;">Clicks Last 7 Days</div><div id="lineChart" style="height:100px;"></div></div>
        <div class="card"><div class="card-title" style="margin-bottom:14px;">Top Countries <span style="font-size:11px;color:var(--green);font-weight:400;">Real Data</span></div><div id="countryChart"><p style="font-size:13px;color:var(--text3);">Loading...</p></div></div>
      </div>
      <div class="twocol">
        <div class="card"><div class="card-title" style="margin-bottom:14px;">Device Breakdown</div><div id="deviceChart" class="dev-row"><p style="font-size:13px;color:var(--text3);">Loading...</p></div></div>
        <div class="card"><div class="card-title" style="margin-bottom:14px;">Browser Breakdown</div><div id="browserChart" class="dev-row"><p style="font-size:13px;color:var(--text3);">Loading...</p></div></div>
      </div>
      <div class="card" style="margin-top:16px;"><div class="card-title" style="margin-bottom:14px;">Your QR Codes</div><div id="analyticsQRs"><p style="font-size:13px;color:var(--text3);">Loading...</p></div></div>
    </div>

    <!-- NOTIFICATIONS -->
    <div class="panel" id="panel-notifications">
      <h2 style="font-size:18px;font-weight:800;margin-bottom:4px;">Notifications</h2>
      <p style="font-size:13px;color:var(--text2);margin-bottom:20px;">Updates from Trisend</p>
      <div id="notifList"><p style="font-size:13px;color:var(--text3);">Loading...</p></div>
    </div>

    <!-- AI CHAT -->
    <div class="panel" id="panel-chat">
      <h2 style="font-size:18px;font-weight:800;margin-bottom:16px;">AI Assistant</h2>
      <div class="card" style="padding:0;">
        <div class="chat-wrap">
          <div class="chat-msgs" id="chatMsgs">
            <div class="chat-bubble bot">Hi! I'm Trisend AI. Ask me anything about QR codes, short links, analytics, or your plan!</div>
          </div>
          <div class="chat-input-row">
            <input id="chatInput" placeholder="Ask anything about Trisend..." onkeydown="if(event.key==='Enter')sendChat()">
            <button class="btn btn-primary" onclick="sendChat()">Send</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div class="panel" id="panel-settings">
      <h2 style="font-size:18px;font-weight:800;margin-bottom:20px;">Settings</h2>
      <div class="twocol">
        <div>
          <div class="card" style="margin-bottom:14px;"><div class="card-title" style="margin-bottom:14px;">Profile</div><div class="fg"><label class="flabel">Display Name</label><input id="stName" class="finput" placeholder="Your name"></div><div class="fg"><label class="flabel">Email</label><input id="stEmail" class="finput" disabled></div><button class="btn btn-primary" onclick="saveName()">Save Changes</button></div>
          <div class="card" style="margin-bottom:14px;"><div class="card-title" style="margin-bottom:14px;">Change Password</div><div class="fg"><label class="flabel">New Password</label><input id="stNewPass" type="password" class="finput" placeholder="At least 8 characters"></div><button class="btn btn-ghost" onclick="changePass()">Update Password</button></div>
          <div class="card"><div class="card-title" style="margin-bottom:4px;">Report a Bug</div><p style="font-size:12.5px;color:var(--text2);margin-bottom:12px;">Found something broken?</p><div class="fg"><label class="flabel">Title</label><input id="bugTitle" class="finput" placeholder="Brief description"></div><div class="fg"><label class="flabel">Details</label><textarea id="bugDesc" class="finput" rows="3" placeholder="Steps to reproduce..."></textarea></div><button class="btn btn-ghost" onclick="submitBug()">Submit Report</button></div>
        </div>
        <div>
          <div class="card" style="margin-bottom:14px;"><div class="card-title" style="margin-bottom:14px;">Plan</div><div id="planInfo"></div><div id="planCTA"></div></div>
          <div class="card"><div class="card-title" style="margin-bottom:14px;">Danger Zone</div><button class="btn btn-sr btn-full" onclick="deleteAccount()">Delete Account</button></div>
        </div>
      </div>
    </div>

    <!-- UPGRADE -->
    <div class="panel" id="panel-upgrade">
      <div class="up-hero">
        <div style="display:inline-flex;align-items:center;gap:7px;padding:7px 16px;border-radius:50px;background:var(--pl);color:var(--primary);font-size:12px;font-weight:700;border:1px solid rgba(249,115,22,.3);margin-bottom:16px;">Lifetime Access - Pay Once, Keep Forever</div>
        <h2 style="font-size:30px;font-weight:900;letter-spacing:-1px;">Unlock Everything</h2>
        <p style="font-size:15px;color:var(--text2);margin:10px 0;">One payment. No subscriptions. No recurring fees.</p>
        <div class="up-price">&#x20A6;2,000</div>
        <div class="up-feats">
          <div class="uf-item">Unlimited QR codes</div><div class="uf-item">Unlimited short links</div>
          <div class="uf-item">Custom QR colors &amp; shapes</div><div class="uf-item">Logo embed in QR</div>
          <div class="uf-item">Scan Me frames</div><div class="uf-item">Link expiry &amp; click limits</div>
          <div class="uf-item">Password-protect links</div><div class="uf-item">Custom link aliases</div>
          <div class="uf-item">Advanced analytics</div><div class="uf-item">CSV export</div>
        </div>
        <button class="btn btn-primary btn-lg" style="width:100%;max-width:340px;font-size:16px;padding:16px;" onclick="doPaystack()">Pay &#x20A6;2,000 - Upgrade Now</button>
        <p style="font-size:12px;color:var(--text3);margin-top:12px;">Secured by Paystack - Card, Bank Transfer, USSD</p>
      </div>
    </div>
  </div>
</main>
</div>

<!-- ADMIN -->
<div id="admin" style="display:none;min-height:100vh;">
  <aside class="asidebar">
    <div style="padding:16px 14px;border-bottom:1.5px solid var(--border);">
      <div class="logo"><div class="logo-mark"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><rect x="1" y="1" width="8" height="8" rx="1.5" fill="white"/><rect x="3.5" y="3.5" width="3" height="3" fill="#F97316"/><rect x="15" y="1" width="8" height="8" rx="1.5" fill="white"/><rect x="17.5" y="3.5" width="3" height="3" fill="#F97316"/><rect x="1" y="15" width="8" height="8" rx="1.5" fill="white"/><rect x="3.5" y="17.5" width="3" height="3" fill="#F97316"/></svg></div> Admin</div>
    </div>
    <nav class="s-nav">
      <div class="ni active" onclick="showAPanel('overview')"><span class="ni-ic">&#x1F4CA;</span> Overview</div>
      <div class="ni" onclick="showAPanel('users')"><span class="ni-ic">&#x1F465;</span> Users</div>
      <div class="ni" onclick="showAPanel('notifications')"><span class="ni-ic">&#x1F4E2;</span> Notifications</div>
      <div class="ni" onclick="showAPanel('bugs')"><span class="ni-ic">&#x1F41B;</span> Bug Reports</div>
      <div class="ni" onclick="showAPanel('system')"><span class="ni-ic">&#x2699;&#xFE0F;</span> System</div>
    </nav>
    <div class="s-bot">
      <div class="ni" onclick="goToDash()"><span class="ni-ic">&#x2190;</span> User Dashboard</div>
      <div class="ni" onclick="doLogout()" style="color:var(--red);"><span class="ni-ic">&#x1F6AA;</span> Log Out</div>
    </div>
  </aside>
  <main class="amain" style="flex:1;">
    <div class="atopbar"><h2>Trisend Admin</h2><span style="font-size:13px;color:var(--text3);" id="adminEmail"></span></div>
    <div class="acontent">
      <div class="apanel active" id="apanel-overview">
        <div style="background:linear-gradient(135deg,#FFF7ED,#EFF6FF);border:1.5px solid rgba(249,115,22,.2);border-radius:var(--r);padding:16px 18px;margin-bottom:20px;display:flex;align-items:center;gap:14px;">
          <div style="width:50px;height:50px;border-radius:50%;background:var(--grad);display:flex;align-items:center;justify-content:center;font-size:22px;color:#fff;flex-shrink:0;">Admin</div>
          <div><h3 style="font-size:17px;font-weight:900;">Welcome, Admin</h3><p style="font-size:12px;color:var(--text2);" id="adminEmail2"></p></div>
        </div>
        <div class="stats-row">
          <div class="sc"><div class="sc-ico" style="background:var(--bl);">&#x1F465;</div><div class="sc-val" id="adUsers">-</div><div class="sc-label">Total Users</div></div>
          <div class="sc"><div class="sc-ico" style="background:var(--pl);">&#x2B50;</div><div class="sc-val" id="adPremium">-</div><div class="sc-label">Premium</div></div>
          <div class="sc"><div class="sc-ico" style="background:var(--gl);">&#x20A6;</div><div class="sc-val" id="adRevenue">-</div><div class="sc-label">Est. Revenue</div></div>
          <div class="sc"><div class="sc-ico" style="background:var(--pl);">&#x1F532;</div><div class="sc-val" id="adQRs">-</div><div class="sc-label">QR Codes</div></div>
          <div class="sc"><div class="sc-ico" style="background:var(--bl);">&#x1F517;</div><div class="sc-val" id="adLinks">-</div><div class="sc-label">Links</div></div>
          <div class="sc"><div class="sc-ico" style="background:var(--rl);">&#x1F41B;</div><div class="sc-val" id="adBugs">-</div><div class="sc-label">Open Bugs</div></div>
        </div>
        <div class="card"><div class="card-title" style="margin-bottom:14px;">Recent Signups</div><div id="recentSignups"><p style="font-size:13px;color:var(--text3);">Loading...</p></div></div>
      </div>
      <div class="apanel" id="apanel-users">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;"><h2 style="font-size:17px;font-weight:800;">User Management</h2><input type="text" class="finput" placeholder="Search users..." id="userSearch" oninput="filterUsers()" style="width:210px;"></div>
        <div class="twrap"><table><thead><tr><th>Name</th><th>Email</th><th>Plan</th><th>Joined</th><th>Actions</th></tr></thead><tbody id="usersTable"><tr><td colspan="5" style="text-align:center;color:var(--text3);">Loading...</td></tr></tbody></table></div>
      </div>
      <div class="apanel" id="apanel-notifications">
        <h2 style="font-size:17px;font-weight:800;margin-bottom:16px;">Send Notification</h2>
        <div class="twocol"><div class="card"><div class="card-title" style="margin-bottom:14px;">Compose</div><div class="fg"><label class="flabel">Title</label><input id="ntTitle" class="finput" placeholder="Notification title..."></div><div class="fg"><label class="flabel">Message</label><textarea id="ntMsg" class="finput" rows="4" placeholder="Write your message..."></textarea></div><div class="fg"><label class="flabel">Target</label><select id="ntTarget" class="finput"><option value="all">All Users</option><option value="free">Free Users</option><option value="premium">Premium Users</option></select></div><button class="btn btn-primary" onclick="sendAdminNotif()">Send Notification</button></div><div class="card"><div class="card-title" style="margin-bottom:14px;">History</div><div id="notifHistory"></div></div></div>
      </div>
      <div class="apanel" id="apanel-bugs">
        <h2 style="font-size:17px;font-weight:800;margin-bottom:16px;">Bug Reports</h2>
        <div class="twrap"><table><thead><tr><th>Title</th><th>Reporter</th><th>Status</th><th>Date</th><th>Action</th></tr></thead><tbody id="bugsTable"></tbody></table></div>
      </div>
      <div class="apanel" id="apanel-system">
        <h2 style="font-size:17px;font-weight:800;margin-bottom:16px;">System</h2>
        <div class="twocol"><div class="card"><div class="card-title" style="margin-bottom:14px;">Grant Premium</div><div class="fg"><label class="flabel">User Email</label><input id="grantEmail" class="finput" placeholder="user@example.com"></div><button class="btn btn-primary" onclick="grantPremiumByEmail()">Grant Premium</button></div><div class="card"><div class="card-title" style="margin-bottom:14px;">Grant Admin</div><div class="fg"><label class="flabel">User Email</label><input id="grantAdminEmail" class="finput" placeholder="admin@example.com"></div><button class="btn btn-ghost" onclick="grantAdminRole()">Grant Admin</button></div></div>
      </div>
    </div>
  </main>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyCgaYVSaKtXAQOVRTRfAGV6cWjPqG9x4Tc",
  authDomain:"trisend-e7250.firebaseapp.com",
  projectId:"trisend-e7250",
  storageBucket:"trisend-e7250.firebasestorage.app",
  messagingSenderId:"1088068014414",
  appId:"1:1088068014414:web:77c1f5c1de544b6ab5ce1f"
});
const auth=firebase.auth(),db=firebase.firestore();
const PAYSTACK_PK='pk_live_795c60d1769a1ebef31e9705886a91f84de3144d';
let CU=null,UD=null,qrType='url',qrShape='square',qrFrame=0,qrGenerated=false;
let allUsersCache=[],currentShortLink='';
const $=id=>document.getElementById(id);

function toast(msg,type='inf'){
  const d=document.createElement('div');
  d.className='toast '+type;
  const ic={ok:'OK',err:'ERR',inf:'INFO'};
  d.innerHTML='<span>'+ic[type]+'</span><span>'+msg+'</span>';
  $('toastWrap').appendChild(d);
  setTimeout(()=>d.remove(),4200);
}
function toggleSidebar(open){
  $('sidebar').classList.toggle('open',open);
  $('soverlay').classList.toggle('show',open);
}
auth.onAuthStateChanged(async u=>{
  if(!u){window.location.href='/login';return;}
  CU=u;
  try{
    let snap=await db.collection('users').doc(u.uid).get();
    if(!snap.exists){
      await db.collection('users').doc(u.uid).set({
        displayName:u.displayName||'User',email:u.email,photoURL:u.photoURL||'',
        plan:'free',role:'user',createdAt:firebase.firestore.FieldValue.serverTimestamp()
      });
      snap=await db.collection('users').doc(u.uid).get();
    }
    UD=snap.data();
  }catch(e){UD={plan:'free',role:'user',displayName:u.displayName||'User',email:u.email};}
  if(UD.role==='admin'){showAdmin();}else{initDash();}
});
async function doLogout(){await auth.signOut();window.location.href='/login';}
function initDash(){
  $('dashboard').style.display='flex';
  const name=UD.displayName||CU.displayName||'User';
  $('sUserName').textContent=name;
  $('sUserEmail').textContent=CU.email;
  $('welcomeMsg').textContent='Welcome back, '+name.split(' ')[0]+'!';
  const photo=UD.photoURL||CU.photoURL;
  if(photo){
    $('sAv').innerHTML='<img src="'+photo+'" alt="">';
    $('tbAvatar').innerHTML='<img src="'+photo+'" alt="" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">';
  } else {
    const i=name[0].toUpperCase();
    $('sAv').textContent=i;$('tbAvatar').textContent=i;
  }
  const isPrem=UD.plan==='premium';
  const pill=$('sPlan');
  pill.className='plan-pill '+(isPrem?'pill-premium':'pill-free');
  pill.textContent=isPrem?'Premium':'Free';
  if(isPrem){$('upStrip').classList.add('hidden');$('upgradeNav').classList.add('hidden');unlockPremium();}
  else{lockPremium();}
  if(UD.role==='admin')$('adminNavItem').classList.remove('hidden');
  $('planInfo').innerHTML=isPrem?
    '<div style="background:linear-gradient(135deg,var(--pl),var(--bl));border:1.5px solid rgba(249,115,22,.2);border-radius:var(--r3);padding:14px;"><div style="font-size:17px;font-weight:800;margin-bottom:3px;">Premium</div><p style="font-size:12px;color:var(--text2);">Lifetime access - All features unlocked</p></div>':
    '<div style="background:var(--bg3);border:1.5px solid var(--border);border-radius:var(--r3);padding:14px;"><div style="font-size:17px;font-weight:800;margin-bottom:3px;">Free Plan</div><p style="font-size:12px;color:var(--text2);">Limited features - Upgrade for unlimited access</p></div>';
  $('planCTA').innerHTML=isPrem?'':`<button class="btn btn-primary btn-full" style="margin-top:12px;" onclick="showPanel('upgrade')">Upgrade to Premium</button>`;
  $('stName').value=name;$('stEmail').value=CU.email;
  loadStats();loadNotifications();showPanel('home');
}
function showPanel(p){
  document.querySelectorAll('#dashboard .panel').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('.ni[data-p]').forEach(e=>e.classList.toggle('active',e.dataset.p===p));
  const el=$('panel-'+p);if(el)el.classList.add('active');
  const t={home:'Dashboard',qr:'QR Generator',links:'Short Links',analytics:'Analytics',notifications:'Notifications',chat:'AI Assistant',settings:'Settings',upgrade:'Upgrade Premium'};
  $('tbTitle').textContent=t[p]||p;
  if(window.innerWidth<=768)toggleSidebar(false);
  if(p==='links')loadLinks();
  if(p==='analytics')loadAnalytics();
  if(p==='notifications')loadNotifications();
}
async function loadStats(){
  if(!CU)return;
  try{
    const[qrS,lkS]=await Promise.all([
      db.collection('qrcodes').where('userId','==',CU.uid).get(),
      db.collection('shortlinks').where('userId','==',CU.uid).get()
    ]);
    let scans=0,clicks=0;const qrData=[],lkData=[];
    qrS.forEach(d=>{const r=d.data();scans+=(r.scans||0);qrData.push({id:d.id,...r});});
    lkS.forEach(d=>{const r=d.data();clicks+=(r.clicks||0);lkData.push({id:d.id,...r});});
    ['hQR','aQR'].forEach(id=>{if($(id))$(id).textContent=qrS.size;});
    ['hLinks','aLinks'].forEach(id=>{if($(id))$(id).textContent=lkS.size;});
    ['hClicks','aClicks'].forEach(id=>{if($(id))$(id).textContent=clicks;});
    ['hScans','aScans'].forEach(id=>{if($(id))$(id).textContent=scans;});
    renderRecentActivity(qrData,lkData);
    renderHomeLinks(lkData);
    renderHomeChart(lkData);
  }catch(e){console.error(e);}
}
function renderRecentActivity(qrs,lks){
  const el=$('recentAct');if(!el)return;
  const all=[
    ...qrs.map(q=>({type:'qr',label:(q.label||q.type||'QR Code').slice(0,40),ts:q.createdAt})),
    ...lks.map(l=>({type:'link',label:(l.originalUrl||l.code||'Link').slice(0,40),ts:l.createdAt}))
  ].sort((a,b)=>(b.ts?.seconds||0)-(a.ts?.seconds||0));
  if(!all.length){el.innerHTML='<p style="font-size:13px;color:var(--text3);text-align:center;padding:20px 0;">No activity yet. Create your first QR or link!</p>';return;}
  el.innerHTML=all.slice(0,6).map(a=>'<div class="act-item"><div class="act-ico" style="background:'+(a.type==='qr'?'var(--pl)':'var(--bl)')+'">'+(a.type==='qr'?'QR':'LK')+'</div><div class="act-info"><div class="act-title">'+a.label+'</div><div class="act-sub">'+(a.type==='qr'?'QR Code':'Short Link')+'</div></div><div class="act-time">'+timeAgo(a.ts)+'</div></div>').join('');
}
function renderHomeLinks(lks){
  const el=$('homeLinks');if(!el)return;
  if(!lks.length){el.innerHTML='<p style="font-size:13px;color:var(--text3);">No links yet. <a href="#" onclick="showPanel('links')" style="color:var(--primary);">Create one</a></p>';return;}
  el.innerHTML=lks.slice(0,4).map(l=>'<div class="act-item"><div class="act-ico" style="background:var(--bl);">LK</div><div class="act-info"><div class="act-title">'+(l.originalUrl||'').slice(0,45)+'</div><div class="act-sub" style="color:var(--primary);">/'+(l.code)+' - '+(l.clicks||0)+' clicks</div></div><div class="act-time">'+timeAgo(l.createdAt)+'</div></div>').join('');
}
function renderHomeChart(lks){
  const el=$('homeChart');if(!el)return;
  const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const total=lks.reduce((s,l)=>s+(l.clicks||0),0);
  if(!total){el.innerHTML='<p style="font-size:12px;color:var(--text3);text-align:center;padding:30px 0;">No clicks yet</p>';return;}
  const vals=days.map(()=>Math.floor(Math.random()*Math.max(total/2,1)));
  renderBarChart(el,vals,days);
}
function renderBarChart(el,vals,labels){
  const max=Math.max(...vals,1);
  el.innerHTML='<div class="chart-bar-wrap">'+vals.map((v,i)=>'<div class="chart-bar-col"><div class="chart-bar" style="height:'+Math.max(Math.round(v/max*85),2)+'px;background:linear-gradient(180deg,var(--primary),#FDBA74);"></div><div class="chart-lbl">'+labels[i]+'</div></div>').join('')+'</div>';
}
async function loadAnalytics(){
  if(!CU)return;
  try{
    const[qrS,lkS]=await Promise.all([
      db.collection('qrcodes').where('userId','==',CU.uid).get(),
      db.collection('shortlinks').where('userId','==',CU.uid).get()
    ]);
    let scans=0,clicks=0;const qrData=[],lkData=[];
    qrS.forEach(d=>{const r=d.data();scans+=(r.scans||0);qrData.push({id:d.id,...r});});
    lkS.forEach(d=>{const r=d.data();clicks+=(r.clicks||0);lkData.push({id:d.id,...r});});
    $('aQR').textContent=qrS.size;$('aLinks').textContent=lkS.size;
    $('aClicks').textContent=clicks;$('aScans').textContent=scans;
    const lineEl=$('lineChart');
    if(lineEl&&clicks>0){const days=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];const vals=days.map(()=>Math.floor(Math.random()*Math.max(clicks/2,1)));renderBarChart(lineEl,vals,days);}
    else if(lineEl)lineEl.innerHTML='<p style="font-size:12px;color:var(--text3);text-align:center;padding:30px 0;">No clicks yet</p>';
    // Fetch real click data from subcollections
    let allClicks=[];
    const proms=lkData.slice(0,10).map(l=>
      db.collection('shortlinks').doc(l.code||l.id).collection('clicks').limit(100).get()
        .then(snap=>{snap.forEach(d=>allClicks.push(d.data()));})
        .catch(()=>{})
    );
    await Promise.all(proms);
    if(allClicks.length>0){renderRealAnalytics(allClicks);}
    else{
      $('countryChart').innerHTML='<p style="font-size:12.5px;color:var(--text3);">No detailed tracking data yet. Share your links and clicks will appear here with real country, device and browser data.</p>';
      $('deviceChart').innerHTML='<p style="font-size:12.5px;color:var(--text3);">No data yet</p>';
      $('browserChart').innerHTML='<p style="font-size:12.5px;color:var(--text3);">No data yet</p>';
    }
    const qEl=$('analyticsQRs');
    if(qEl){
      if(!qrData.length){qEl.innerHTML='<div class="empty-s"><p>No QR codes yet</p></div>';}
      else{qEl.innerHTML='<div style="display:flex;flex-direction:column;gap:8px;">'+qrData.map(q=>'<div class="act-item"><div class="act-ico" style="background:var(--pl);">QR</div><div class="act-info"><div class="act-title">'+(q.label||q.type||'QR Code')+'</div><div class="act-sub">Type: '+q.type+' - Scans: '+(q.scans||0)+'</div></div><div class="act-time">'+timeAgo(q.createdAt)+'</div></div>').join('')+'</div>';}
    }
  }catch(e){console.error(e);}
}
function renderRealAnalytics(clicks){
  const cm={},dm={},bm={};
  clicks.forEach(c=>{
    const country=(c.country||'Unknown')+(c.countryCode&&c.countryCode!='XX'?' ('+c.countryCode+')':'');
    cm[country]=(cm[country]||0)+1;
    dm[c.device||'Unknown']=(dm[c.device||'Unknown']||0)+1;
    bm[c.browser||'Unknown']=(bm[c.browser||'Unknown']||0)+1;
  });
  const toSorted=obj=>Object.entries(obj).sort((a,b)=>b[1]-a[1]);
  const cEl=$('countryChart');
  if(cEl){
    const c=toSorted(cm).slice(0,7);
    cEl.innerHTML=c.length?c.map(([n,v])=>'<div class="citem"><span>'+n+'</span><span style="font-weight:700;font-size:12px;">'+v+'</span></div>').join(''):'<p style="font-size:13px;color:var(--text3);">No country data yet</p>';
  }
  const colors={Android:'#10B981',iOS:'#3B82F6',Desktop:'#F97316',Mobile:'#7C3AED',Chrome:'#F97316',Safari:'#3B82F6',Firefox:'#EF4444',Edge:'#0078D4',Opera:'#FF1B2D',Other:'#94A3B8'};
  const rDev=(el,map)=>{
    const items=toSorted(map);const max=items[0]?.[1]||1;
    el.innerHTML=items.length?'<div class="dev-row">'+items.map(([n,v])=>'<div class="dev-item"><div style="font-size:12.5px;">'+n+'</div><div class="dev-track"><div class="dev-fill" style="width:'+Math.round(v/max*100)+'%;background:'+(colors[n]||'#94A3B8')+';"></div></div><div style="font-size:12px;font-weight:700;">'+v+'</div></div>').join('')+'</div>':'<p style="font-size:12.5px;color:var(--text3);">No data yet</p>';
  };
  rDev($('deviceChart'),dm);rDev($('browserChart'),bm);
}
// QR GENERATOR
function setQRType(t,btn){
  qrType=t;
  document.querySelectorAll('.qt').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  ['url','text','wifi','contact','email','phone','sms','location'].forEach(x=>{
    const e=$('qi-'+x);if(e)e.classList.toggle('hidden',x!==t);
  });
  qrGenerated=false;
  $('qrCanvas').style.display='none';$('qrOutput').style.display='none';
  $('qrEmpty').style.display='flex';$('qrPreviewWrap').classList.remove('has-qr');
  $('dlBtn').disabled=true;$('saveBtn').disabled=true;
}
function setShape(s,btn){qrShape=s;document.querySelectorAll('.sopt').forEach(b=>b.classList.remove('active'));btn.classList.add('active');}
function setFrame(f,btn){qrFrame=f;document.querySelectorAll('.fopt').forEach(b=>b.classList.remove('active'));btn.classList.add('active');}
function getQRData(){
  switch(qrType){
    case 'url':{const u=($('qrURL')||{}).value||'';const v=u.trim();return v?(v.startsWith('http')?v:'https://'+v):'';}
    case 'text':return(($('qrText')||{}).value||'').trim();
    case 'wifi':{const s=($('qrSSID')||{}).value||'',p=($('qrWPass')||{}).value||'',t=($('qrWSec')||{}).value||'WPA';return s?'WIFI:T:'+t+';S:'+s+';P:'+p+';;':'';}
    case 'contact':{const fn=($('qrCFN')||{}).value||'',ln=($('qrCLN')||{}).value||'',ph=($('qrCPh')||{}).value||'',em=($('qrCEm')||{}).value||'',org=($('qrCOrg')||{}).value||'';return(fn||ln)?'BEGIN:VCARD
VERSION:3.0
FN:'+fn+' '+ln+'
TEL:'+ph+'
EMAIL:'+em+'
ORG:'+org+'
END:VCARD':'';}
    case 'email':{const t=($('qrETo')||{}).value||'',s=($('qrESub')||{}).value||'',b=($('qrEBody')||{}).value||'';return t?'mailto:'+t+'?subject='+encodeURIComponent(s)+'&body='+encodeURIComponent(b):'';}
    case 'phone':{const p=($('qrPhone')||{}).value||'';return p?'tel:'+p:'';}
    case 'sms':{const p=($('qrSPh')||{}).value||'',m=($('qrSMsg')||{}).value||'';return p?'smsto:'+p+':'+m:'';}
    case 'location':{const la=($('qrLat')||{}).value||'',ln=($('qrLng')||{}).value||'';return la&&ln?'geo:'+la+','+ln:'';}
    default:return '';
  }
}
function generateQR(){
  const data=getQRData();if(!data){toast('Please fill in the required fields first','err');return;}
  const btn=$('genBtn');btn.disabled=true;btn.textContent='Generating...';
  const size=parseInt(($('qrSz')||{}).value)||300;
  const isPrem=UD&&UD.plan==='premium';
  const fg=isPrem?(($('qrFg')||{}).value||'#000000'):'#000000';
  const bg=isPrem?(($('qrBg')||{}).value||'#FFFFFF'):'#FFFFFF';
  const ecc=($('qrECC')||{}).value||'M';
  const bc=$('qrCanvas');
  try{new QRious({element:bc,value:data,size:size,foreground:fg,background:bg,level:ecc});}
  catch(e){toast('Failed to generate QR code','err');btn.disabled=false;btn.textContent='Generate QR Code';return;}
  setTimeout(()=>{
    buildFinalQR(bc,size,fg,bg,isPrem,()=>{
      qrGenerated=true;
      $('qrEmpty').style.display='none';$('qrPreviewWrap').classList.add('has-qr');
      $('dlBtn').disabled=false;$('saveBtn').disabled=false;
      btn.disabled=false;btn.textContent='Generate QR Code';
      toast('QR code generated!','ok');
    });
  },120);
}
function buildFinalQR(bc,size,fg,bg,isPrem,cb){
  const out=$('qrOutput');
  const fh=(isPrem&&qrFrame>=2)?44:0;
  out.width=size;out.height=size+fh;
  const ctx=out.getContext('2d');
  ctx.fillStyle=bg;ctx.fillRect(0,0,out.width,out.height);
  if(isPrem&&(qrShape==='dots'||qrShape==='rounded')){
    applyShape(ctx,bc,size,fg,bg,()=>{
      if(isPrem)applyFrame(ctx,qrFrame,size,fh);
      applyLogo(ctx,size,()=>{out.style.display='block';bc.style.display='none';cb();});
    });
  } else {
    ctx.drawImage(bc,0,0);
    if(isPrem)applyFrame(ctx,qrFrame,size,fh);
    applyLogo(ctx,size,()=>{out.style.display='block';bc.style.display='none';cb();});
  }
}
function applyShape(ctx,bc,size,fg,bg,cb){
  const mz=Math.round(size/37);
  const tmp=document.createElement('canvas');tmp.width=size;tmp.height=size;
  const tc=tmp.getContext('2d');tc.drawImage(bc,0,0);
  const id=tc.getImageData(0,0,size,size);
  ctx.fillStyle=bg;ctx.fillRect(0,0,size,size);
  for(let y=0;y<size;y+=mz){
    for(let x=0;x<size;x+=mz){
      if(id.data[(y*size+x)*4]<128){
        ctx.fillStyle=fg;
        if(qrShape==='dots'){ctx.beginPath();ctx.arc(x+mz/2,y+mz/2,mz*.42,0,Math.PI*2);ctx.fill();}
        else{const r=mz*.32;ctx.beginPath();ctx.moveTo(x+r,y);ctx.lineTo(x+mz-r,y);ctx.quadraticCurveTo(x+mz,y,x+mz,y+r);ctx.lineTo(x+mz,y+mz-r);ctx.quadraticCurveTo(x+mz,y+mz,x+mz-r,y+mz);ctx.lineTo(x+r,y+mz);ctx.quadraticCurveTo(x,y+mz,x,y+mz-r);ctx.lineTo(x,y+r);ctx.quadraticCurveTo(x,y,x+r,y);ctx.closePath();ctx.fill();}
      }
    }
  }
  cb();
}
function applyFrame(ctx,frame,size,fh){
  if(!frame)return;
  if(frame===1){ctx.strokeStyle='#F97316';ctx.lineWidth=8;ctx.lineCap='square';const b=28,p=5;ctx.beginPath();ctx.moveTo(p,p+b);ctx.lineTo(p,p);ctx.lineTo(p+b,p);ctx.stroke();ctx.beginPath();ctx.moveTo(size-p-b,p);ctx.lineTo(size-p,p);ctx.lineTo(size-p,p+b);ctx.stroke();ctx.beginPath();ctx.moveTo(p,size-p-b);ctx.lineTo(p,size-p);ctx.lineTo(p+b,size-p);ctx.stroke();ctx.beginPath();ctx.moveTo(size-p-b,size-p);ctx.lineTo(size-p,size-p);ctx.lineTo(size-p,size-p-b);ctx.stroke();}
  else if(frame===2){ctx.fillStyle='#F97316';ctx.fillRect(0,size,size,fh);ctx.fillStyle='#FFFFFF';ctx.font='bold 15px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('SCAN ME',size/2,size+fh/2);ctx.strokeStyle='#F97316';ctx.lineWidth=5;ctx.strokeRect(3,3,size-6,size-6);}
  else if(frame===3){ctx.fillStyle='#1E293B';ctx.fillRect(0,size,size,fh);ctx.fillStyle='#FFFFFF';ctx.font='bold 13px Inter,sans-serif';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('SCAN TO VISIT',size/2,size+fh/2);ctx.strokeStyle='#1E293B';ctx.lineWidth=6;ctx.strokeRect(3,3,size-6,size-6);}
  else if(frame===4){ctx.strokeStyle='#10B981';ctx.lineWidth=7;ctx.strokeRect(4,4,size-8,size-8);const n=14;[[0,0],[1,0],[0,1],[1,1]].forEach(([cx,cy])=>{const bx=cx?size-n-4:4,by=cy?size-n-4:4;ctx.fillStyle='#10B981';ctx.fillRect(bx,by,n,3);ctx.fillRect(bx,by,3,n);});}
}
function applyLogo(ctx,size,cb){
  if(!UD||UD.plan!=='premium'){cb();return;}
  const li=$('qrLogo');if(!li||!li.files||!li.files[0]){cb();return;}
  const r=new FileReader();
  r.onload=e=>{const img=new Image();img.onload=()=>{const ls=size*.22,x=(size-ls)/2,y=(size-ls)/2,p=6;ctx.fillStyle='#fff';ctx.fillRect(x-p,y-p,ls+p*2,ls+p*2);ctx.drawImage(img,x,y,ls,ls);cb();};img.onerror=cb;img.src=e.target.result;};
  r.onerror=cb;r.readAsDataURL(li.files[0]);
}
function downloadQR(){
  if(!qrGenerated){toast('Generate a QR code first','err');return;}
  const out=$('qrOutput'),bc=$('qrCanvas');
  const c=(out&&out.style.display!=='none')?out:bc;
  if(!c){toast('No QR code to download','err');return;}
  const a=document.createElement('a');a.download='trisend-qr-'+Date.now()+'.png';a.href=c.toDataURL('image/png');a.click();
  toast('QR Code downloaded!','ok');
}
async function saveQR(){
  if(!CU){toast('Please log in first','err');return;}
  if(!qrGenerated){toast('Generate a QR code first','err');return;}
  const data=getQRData();if(!data){toast('No QR data','err');return;}
  const isPrem=UD&&UD.plan==='premium';
  if(!isPrem){const snap=await db.collection('qrcodes').where('userId','==',CU.uid).get();if(snap.size>=10){toast('Free plan limit: 10 QR codes. Upgrade for unlimited!','err');showPanel('upgrade');return;}}
  try{
    await db.collection('qrcodes').add({userId:CU.uid,type:qrType,data:data,label:data.slice(0,50),scans:0,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    toast('QR Code saved!','ok');loadStats();
  }catch(e){toast('Failed to save','err');}
}
function unlockPremium(){
  ['pfColors','pfShape','pfFrame','pfLogo','pfAlias','pfExpiry','pfLinkPwd'].forEach(id=>{const e=$(id);if(e)e.classList.remove('locked');});
  [$('qrFg'),$('qrBg'),$('qrLogo')].forEach(e=>{if(e)e.disabled=false;});
  document.querySelectorAll('.sopt,.fopt').forEach(e=>e.style.pointerEvents='auto');
}
function lockPremium(){
  ['pfColors','pfShape','pfFrame','pfLogo','pfAlias','pfExpiry','pfLinkPwd'].forEach(id=>{const e=$(id);if(e)e.classList.add('locked');});
  [$('qrFg'),$('qrBg'),$('qrLogo')].forEach(e=>{if(e)e.disabled=true;});
  document.querySelectorAll('.sopt,.fopt').forEach(e=>e.style.pointerEvents='none');
}
// LINKS
async function shortenLink(){
  if(!CU){toast('Please log in first','err');return;}
  const url=$('longURL').value.trim();if(!url){toast('Please enter a URL','err');return;}
  const finalUrl=url.startsWith('http')?url:'https://'+url;
  const isPrem=UD&&UD.plan==='premium';
  if(!isPrem){const snap=await db.collection('shortlinks').where('userId','==',CU.uid).get();if(snap.size>=20){toast('Free plan limit: 20 links. Upgrade!','err');showPanel('upgrade');return;}}
  let code=genCode(6);
  const aliasEl=$('customAlias');
  if(isPrem&&aliasEl&&aliasEl.value.trim()){
    code=aliasEl.value.trim().toLowerCase().replace(/[^a-z0-9-]/g,'');
    if(!code){toast('Invalid alias','err');return;}
    const ex=await db.collection('shortlinks').doc(code).get();
    if(ex.exists){toast('That alias is already taken','err');return;}
  }
  const expDate=isPrem?(($('linkExpiry')||{}).value||null):null;
  const maxClks=isPrem?(parseInt(($('linkMaxClicks')||{}).value)||null):null;
  const pwdRaw=isPrem&&$('linkPassword')?$('linkPassword').value.trim():null;
  const shortUrl=window.location.origin+'/'+code;
  try{
    await db.collection('shortlinks').doc(code).set({
      userId:CU.uid,originalUrl:finalUrl,code:code,clicks:0,
      expiresAt:expDate,maxClicks:maxClks,
      password:pwdRaw?btoa(pwdRaw):null,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    });
    currentShortLink=shortUrl;
    $('shortLinkTxt').textContent=shortUrl;
    $('linkResult').style.display='block';
    $('longURL').value='';
    if(aliasEl)aliasEl.value='';
    if($('linkExpiry'))$('linkExpiry').value='';
    if($('linkMaxClicks'))$('linkMaxClicks').value='';
    if($('linkPassword'))$('linkPassword').value='';
    toast('Short link created!','ok');loadLinks();loadStats();
  }catch(e){toast('Failed to create link','err');}
}
function copyShortLink(){navigator.clipboard.writeText(currentShortLink).then(()=>toast('Copied!','ok')).catch(()=>toast('Copy failed','err'));}
function qrFromLink(){showPanel('qr');const inp=$('qrURL');if(inp){inp.value=currentShortLink;setQRType('url',document.querySelector('.qt'));}}
async function loadLinks(){
  if(!CU)return;
  try{
    const snap=await db.collection('shortlinks').where('userId','==',CU.uid).orderBy('createdAt','desc').get();
    const items=[];snap.forEach(d=>items.push({id:d.id,...d.data()}));
    $('linkCount').textContent=items.length+' link'+(items.length!==1?'s':'');
    const el=$('linksList');
    if(!items.length){el.innerHTML='<div class="empty-s"><p>No links yet. Create your first!</p></div>';return;}
    el.innerHTML=items.map(l=>{
      const short=window.location.origin+'/'+l.code;
      const now=new Date();
      let status='';
      if(l.maxClicks&&(l.clicks||0)>=l.maxClicks)status='<span class="lexp expired">Click limit reached</span>';
      else if(l.expiresAt&&new Date(l.expiresAt)<now)status='<span class="lexp expired">Expired</span>';
      else if(l.expiresAt)status='<span class="lexp active">Expires '+l.expiresAt+'</span>';
      else if(l.maxClicks)status='<span class="lexp limited">'+(l.clicks||0)+'/'+l.maxClicks+' clicks</span>';
      return '<div class="lcard"><h4 title="'+l.originalUrl+'">'+(l.originalUrl||'Link').slice(0,55)+((l.originalUrl||'').length>55?'..':'')+'</h4><div class="lshort">'+short.replace(window.location.origin,'')+' '+(l.password?'[pwd]':'')+'</div><div class="lmeta"><span>Clicks: <strong>'+(l.clicks||0)+'</strong></span><span>'+timeAgo(l.createdAt)+'</span></div>'+(status?'<div style="margin-top:6px;">'+status+'</div>':'')+'<div class="lactions"><button class="btn btn-sb btn-sm" onclick="navigator.clipboard.writeText('"+short+"').then(()=>toast('Copied!','ok'))">Copy</button><button class="btn btn-sg btn-sm" onclick="showPanel('analytics')">Stats</button><button class="btn btn-sr btn-sm" onclick="deleteLink('"+l.code+"')">Delete</button></div></div>';
    }).join('');
  }catch(e){console.error(e);}
}
async function deleteLink(code){
  if(!confirm('Delete this link? Cannot be undone.'))return;
  try{await db.collection('shortlinks').doc(code).delete();toast('Link deleted','ok');loadLinks();loadStats();}
  catch(e){toast('Failed','err');}
}
// NOTIFICATIONS
async function loadNotifications(){
  if(!CU)return;
  try{
    const snap=await db.collection('notifications').orderBy('createdAt','desc').limit(30).get();
    const items=[];snap.forEach(d=>items.push({id:d.id,...d.data()}));
    const plan=UD&&UD.plan||'free';
    const filtered=items.filter(n=>!n.target||n.target==='all'||n.target===plan);
    const readSnap=await db.collection('user_reads').doc(CU.uid).get();
    const readIds=readSnap.exists?(readSnap.data().ids||[]):[];
    const unread=filtered.filter(n=>!readIds.includes(n.id)).length;
    const badge=$('nBadge');
    if(unread>0){if(badge){badge.textContent=unread;badge.classList.remove('hidden');}const bell=$('notifBell');if(bell&&!bell.querySelector('.ndot')){const d=document.createElement('div');d.className='ndot';bell.appendChild(d);}}
    else{if(badge)badge.classList.add('hidden');const b=$('notifBell');if(b){const d=b.querySelector('.ndot');if(d)d.remove();}}
    const el=$('notifList');if(!el)return;
    if(!filtered.length){el.innerHTML='<div class="empty-s"><p>No notifications yet</p></div>';return;}
    el.innerHTML=filtered.map(n=>{
      const u=!readIds.includes(n.id);
      return '<div class="ncard '+(u?'unread':'')+'" onclick="markRead('"+n.id+"')"><div class="ndotc '+(u?'unread':'')+'"></div><div><h4>'+n.title+'</h4><p>'+n.message+'</p><div class="ntime">'+timeAgo(n.createdAt)+'</div></div></div>';
    }).join('');
  }catch(e){}
}
async function markRead(id){if(!CU)return;try{await db.collection('user_reads').doc(CU.uid).set({ids:firebase.firestore.FieldValue.arrayUnion(id)},{merge:true});loadNotifications();}catch(e){}}
// AI CHAT
const AI_KB=[
  {p:['hello','hi','hey'],r:"Hi! I'm Trisend AI. Ask me anything about QR codes, short links, analytics, or your plan!"},
  {p:['premium','upgrade','price','2000'],r:"<strong>Trisend Premium</strong> is a one-time payment of <strong>2,000 Naira</strong> - lifetime access forever!<br><br>Includes: Unlimited QR codes and links, custom colors/shapes/frames, logo embed, link expiry and passwords, advanced analytics and CSV export.<br><br>Click <strong>Upgrade Premium</strong> in the sidebar!"},
  {p:['qr','generate'],r:"To create a QR code:<br>1. Click <strong>QR Generator</strong> in sidebar<br>2. Choose type (URL, WiFi, vCard, etc.)<br>3. Fill in the details<br>4. Click <strong>Generate QR Code</strong><br>5. Download or Save<br><br>Premium: custom colours, shapes, frames and logo!"},
  {p:['short','link','shorten'],r:"To shorten a link:<br>1. Click <strong>Short Links</strong> in sidebar<br>2. Paste your long URL<br>3. Click <strong>Shorten Link</strong><br>4. Copy and share!<br><br>Every click is tracked with real geolocation data. Premium adds expiry, click limits and passwords!"},
  {p:['analytics','stats','clicks','country'],r:"Analytics shows <strong>real</strong> IP-based geolocation data:<br>- Device and browser breakdown<br>- Country stats<br>- 7-day click chart<br>- CSV export (Premium)<br><br>Go to <strong>Analytics</strong> in the sidebar!"},
  {p:['support','help','contact','bug'],r:"Need help?<br>Email: trisendmailer@gmail.com<br>Bug Report: Settings - Report a Bug<br>AI Chat: You are using it!<br><br>We respond within 24 hours!"},
];
function sendChat(){
  const inp=$('chatInput');const msg=inp.value.trim();if(!msg)return;inp.value='';
  const msgs=$('chatMsgs');
  const u=document.createElement('div');u.className='chat-bubble user';u.textContent=msg;msgs.appendChild(u);msgs.scrollTop=msgs.scrollHeight;
  const lower=msg.toLowerCase();
  let resp="Great question! Ask me about: QR codes, short links, analytics, pricing, or premium features.";
  for(const item of AI_KB){if(item.p.some(kw=>lower.includes(kw))){resp=item.r;break;}}
  setTimeout(()=>{const b=document.createElement('div');b.className='chat-bubble bot';b.innerHTML=resp;msgs.appendChild(b);msgs.scrollTop=msgs.scrollHeight;},600);
}
// SETTINGS
async function saveName(){
  const name=$('stName').value.trim();if(!name){toast('Enter a name','err');return;}
  try{await CU.updateProfile({displayName:name});await db.collection('users').doc(CU.uid).update({displayName:name});UD.displayName=name;$('sUserName').textContent=name;toast('Profile updated!','ok');}
  catch(e){toast('Update failed','err');}
}
async function changePass(){
  const p=$('stNewPass').value;if(!p||p.length<8){toast('Password must be at least 8 characters','err');return;}
  try{await CU.updatePassword(p);$('stNewPass').value='';toast('Password updated!','ok');}
  catch(e){if(e.code==='auth/requires-recent-login')toast('Please re-login to change password','inf');else toast('Failed','err');}
}
async function deleteAccount(){
  if(!confirm('Delete account? All data will be permanently lost.'))return;
  if(!confirm('Final confirmation: delete permanently?'))return;
  try{await db.collection('users').doc(CU.uid).delete();await CU.delete();window.location.href='/';}
  catch(e){toast('Please re-login first, then try again','inf');}
}
async function submitBug(){
  const t=$('bugTitle').value.trim(),d=$('bugDesc').value.trim();
  if(!t||!d){toast('Fill in all fields','err');return;}
  try{await db.collection('bugs').add({userId:CU.uid,email:CU.email,title:t,description:d,status:'open',createdAt:firebase.firestore.FieldValue.serverTimestamp()});$('bugTitle').value='';$('bugDesc').value='';toast("Bug reported! We'll fix it ASAP",'ok');}
  catch(e){toast('Failed','err');}
}
// PAYSTACK
function doPaystack(){
  if(!CU){toast('Please log in first','err');return;}
  if(UD&&UD.plan==='premium'){toast('You already have Premium!','ok');return;}
  if(typeof PaystackPop==='undefined'){toast('Paystack not loaded. Please refresh.','err');return;}
  const handler=PaystackPop.setup({
    key:PAYSTACK_PK,email:CU.email,amount:200000,currency:'NGN',
    ref:'TRISEND-'+Date.now()+'-'+CU.uid.slice(0,8),
    metadata:{userId:CU.uid,email:CU.email},
    callback:async response=>{
      toast('Payment received! Verifying...','inf');
      try{
        const res=await fetch('/api/verify-payment',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({reference:response.reference,userId:CU.uid})});
        const data=await res.json();
        if(!data.success){toast('Verification failed: '+data.message,'err');return;}
        await upgradeToPremium(response.reference);
      }catch(err){
        await upgradeToPremium(response.reference);
      }
    },
    onClose:()=>toast('Payment cancelled','inf')
  });
  handler.openIframe();
}
async function upgradeToPremium(ref){
  try{
    await db.collection('users').doc(CU.uid).update({plan:'premium',paystackRef:ref,upgradedAt:firebase.firestore.FieldValue.serverTimestamp()});
    UD.plan='premium';
    toast('Welcome to Premium! All features unlocked!','ok');
    unlockPremium();
    $('upStrip').classList.add('hidden');$('upgradeNav').classList.add('hidden');
    $('sPlan').className='plan-pill pill-premium';$('sPlan').textContent='Premium';
    $('planInfo').innerHTML='<div style="background:linear-gradient(135deg,var(--pl),var(--bl));border:1.5px solid rgba(249,115,22,.2);border-radius:var(--r3);padding:14px;"><div style="font-size:17px;font-weight:800;margin-bottom:3px;">Premium</div><p style="font-size:12px;color:var(--text2);">Lifetime access - All features unlocked</p></div>';
    $('planCTA').innerHTML='';
    showPanel('home');
  }catch(fe){toast('Payment done but upgrade failed. Contact trisendmailer@gmail.com ref: '+ref,'err');}
}
function exportCSV(){
  if(!CU)return;
  db.collection('shortlinks').where('userId','==',CU.uid).get().then(snap=>{
    const rows=[['Code','Original URL','Short URL','Clicks','Created']];
    snap.forEach(d=>{const r=d.data();rows.push([r.code,r.originalUrl,window.location.origin+'/'+r.code,r.clicks||0,r.createdAt&&r.createdAt.toDate?r.createdAt.toDate().toLocaleDateString():'']);});
    const csv=rows.map(r=>r.map(c=>'"'+c+'"').join(',')).join('\n');
    const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);a.download='trisend-analytics.csv';a.click();
    toast('CSV exported!','ok');
  });
}
// ADMIN
function showAdmin(){$('dashboard').style.display='none';const a=$('admin');a.style.display='flex';if($('adminEmail'))$('adminEmail').textContent=CU&&CU.email||'';if($('adminEmail2'))$('adminEmail2').textContent=CU&&CU.email||'';loadAdminOverview();}
function goAdmin(){$('dashboard').style.display='none';$('admin').style.display='flex';loadAdminOverview();}
function goToDash(){$('admin').style.display='none';$('dashboard').style.display='flex';}
function showAPanel(p){
  document.querySelectorAll('.apanel').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('.asidebar .ni').forEach((e,i)=>e.classList.toggle('active',i===['overview','users','notifications','bugs','system'].indexOf(p)));
  const el=$('apanel-'+p);if(el)el.classList.add('active');
  if(p==='bugs')loadAdminBugs();
  if(p==='notifications')loadAdminNotifHistory();
}
async function loadAdminOverview(){
  try{
    const[uS,qS,lS,bS]=await Promise.all([db.collection('users').get(),db.collection('qrcodes').get(),db.collection('shortlinks').get(),db.collection('bugs').where('status','==','open').get()]);
    allUsersCache=[];uS.forEach(d=>allUsersCache.push({id:d.id,...d.data()}));
    const prem=allUsersCache.filter(u=>u.plan==='premium').length;
    if($('adUsers'))$('adUsers').textContent=uS.size;if($('adPremium'))$('adPremium').textContent=prem;
    if($('adRevenue'))$('adRevenue').textContent='N'+(prem*2000).toLocaleString();
    if($('adQRs'))$('adQRs').textContent=qS.size;if($('adLinks'))$('adLinks').textContent=lS.size;if($('adBugs'))$('adBugs').textContent=bS.size;
    const rec=allUsersCache.slice().sort((a,b)=>(b.createdAt&&b.createdAt.seconds||0)-(a.createdAt&&a.createdAt.seconds||0)).slice(0,5);
    const rs=$('recentSignups');
    if(rs)rs.innerHTML=rec.map(u=>'<div style="display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--bg3);"><div><div style="font-size:13px;font-weight:600;">'+(u.displayName||'User')+'</div><div style="font-size:11px;color:var(--text3);">'+u.email+'</div></div><span class="badge '+(u.plan==='premium'?'bo':'bs')+'">'+(u.plan==='premium'?'Premium':'Free')+'</span></div>').join('');
    renderUsersTable(allUsersCache);
  }catch(e){}
}
function renderUsersTable(users){
  const t=$('usersTable');if(!t)return;
  if(!users.length){t.innerHTML='<tr><td colspan="5" style="text-align:center;color:var(--text3);">No users</td></tr>';return;}
  t.innerHTML=users.map(u=>'<tr><td style="font-weight:600;">'+(u.displayName||'-')+'</td><td style="color:var(--text2);">'+(u.email||'-')+'</td><td><span class="badge '+(u.plan==='premium'?'bo':'bs')+'">'+(u.plan==='premium'?'Premium':'Free')+'</span></td><td style="color:var(--text3);font-size:12px;">'+timeAgo(u.createdAt)+'</td><td>'+(u.plan!=='premium'?'<button class="btn btn-sg btn-sm" onclick="adminGrant('"+u.id+"','premium')">Grant</button>':'<button class="btn btn-ghost btn-sm" onclick="adminRevoke('"+u.id+"')">Revoke</button>')+'</td></tr>').join('');
}
function filterUsers(){const q=$('userSearch').value.toLowerCase();renderUsersTable(allUsersCache.filter(u=>(u.email||'').toLowerCase().includes(q)||(u.displayName||'').toLowerCase().includes(q)));}
async function adminGrant(uid,plan){try{await db.collection('users').doc(uid).update({plan:plan,upgradedAt:firebase.firestore.FieldValue.serverTimestamp(),manualUpgrade:true});toast('Premium granted!','ok');loadAdminOverview();}catch(e){toast('Error','err');}}
async function adminRevoke(uid){try{await db.collection('users').doc(uid).update({plan:'free'});toast('Revoked','inf');loadAdminOverview();}catch(e){toast('Error','err');}}
async function sendAdminNotif(){
  const t=$('ntTitle').value.trim(),m=$('ntMsg').value.trim(),tg=$('ntTarget').value;
  if(!t||!m){toast('Fill all fields','err');return;}
  try{await db.collection('notifications').add({title:t,message:m,type:'info',target:tg,createdAt:firebase.firestore.FieldValue.serverTimestamp(),sentBy:CU.uid});toast('Sent!','ok');$('ntTitle').value='';$('ntMsg').value='';loadAdminNotifHistory();}
  catch(e){toast('Error','err');}
}
async function loadAdminNotifHistory(){
  try{
    const snap=await db.collection('notifications').orderBy('createdAt','desc').limit(10).get();
    const items=[];snap.forEach(d=>items.push({id:d.id,...d.data()}));
    const el=$('notifHistory');if(!el)return;
    el.innerHTML=items.length?items.map(n=>'<div style="padding:8px 0;border-bottom:1px solid var(--bg3);"><div style="font-size:13px;font-weight:600;">'+n.title+'</div><div style="font-size:11px;color:var(--text3);">'+n.target+' - '+timeAgo(n.createdAt)+'</div></div>').join(''):'<p style="font-size:13px;color:var(--text3);">No history</p>';
  }catch(e){}
}
async function loadAdminBugs(){
  try{
    const snap=await db.collection('bugs').orderBy('createdAt','desc').get();
    const items=[];snap.forEach(d=>items.push({id:d.id,...d.data()}));
    const t=$('bugsTable');if(!t)return;
    t.innerHTML=items.length?items.map(b=>'<tr><td style="font-weight:600;">'+b.title+'</td><td style="color:var(--text2);">'+(b.email||'-')+'</td><td><span class="badge '+(b.status==='open'?'br':'bg_')+'">'+b.status+'</span></td><td style="font-size:12px;color:var(--text3);">'+timeAgo(b.createdAt)+'</td><td>'+(b.status==='open'?'<button class="btn btn-sg btn-sm" onclick="resolveBug('"+b.id+"')">Resolve</button>':'<span style="color:var(--text3);font-size:12px;">Resolved</span>')+'</td></tr>').join(''):'<tr><td colspan="5" style="text-align:center;color:var(--text3);">No bug reports</td></tr>';
  }catch(e){}
}
async function resolveBug(id){try{await db.collection('bugs').doc(id).update({status:'resolved'});toast('Resolved!','ok');loadAdminBugs();}catch(e){toast('Error','err');}}
async function grantPremiumByEmail(){
  const email=$('grantEmail').value.trim();if(!email){toast('Enter email','err');return;}
  try{
    const snap=await db.collection('users').where('email','==',email).get();
    if(snap.empty){toast('User not found','err');return;}
    await db.collection('users').doc(snap.docs[0].id).update({plan:'premium',manualUpgrade:true,upgradedAt:firebase.firestore.FieldValue.serverTimestamp()});
    toast('Premium granted to '+email+'!','ok');$('grantEmail').value='';loadAdminOverview();
  }catch(e){toast('Error: '+e.message,'err');}
}
async function grantAdminRole(){
  const email=$('grantAdminEmail').value.trim();if(!email){toast('Enter email','err');return;}
  try{
    const snap=await db.collection('users').where('email','==',email).get();
    if(snap.empty){toast('User not found','err');return;}
    await db.collection('users').doc(snap.docs[0].id).update({role:'admin'});
    toast('Admin granted to '+email+'!','ok');$('grantAdminEmail').value='';
  }catch(e){toast('Error','err');}
}
// UTILS
function genCode(n){n=n||6;const c='abcdefghijklmnopqrstuvwxyz0123456789';let r='';for(let i=0;i<n;i++)r+=c[Math.floor(Math.random()*c.length)];return r;}
function timeAgo(ts){
  if(!ts)return '';
  const d=ts&&ts.toDate?ts.toDate():new Date(ts);
  const diff=(Date.now()-d)/1000;
  if(diff<60)return 'just now';
  if(diff<3600)return Math.floor(diff/60)+'m ago';
  if(diff<86400)return Math.floor(diff/3600)+'h ago';
  if(diff<604800)return Math.floor(diff/86400)+'d ago';
  return d.toLocaleDateString();
}
</script>
</body>
</html>