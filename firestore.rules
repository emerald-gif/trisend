rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── USERS ──────────────────────────────────────────────────────────────
    // Users can only read/write their own profile
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Admins can read all users
      allow read: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // ── QR CODES ───────────────────────────────────────────────────────────
    // Users can only access their own QR codes
    match /qrcodes/{docId} {
      allow read, delete: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // ── SHORT LINKS ────────────────────────────────────────────────────────
    // Public read (needed for redirect lookup on server)
    // Only owner can create/update/delete
    match /shortlinks/{code} {
      allow read: if true;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;

      // Clicks subcollection — only server (Admin SDK) writes; owner can read
      match /clicks/{clickId} {
        allow read: if request.auth != null &&
          get(/databases/$(database)/documents/shortlinks/$(code)).data.userId == request.auth.uid;
        allow write: if false; // Server-side Admin SDK only
      }
    }

    // ── NOTIFICATIONS ──────────────────────────────────────────────────────
    // Any authenticated user can read; only admins can write
    match /notifications/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // ── USER READ RECEIPTS ─────────────────────────────────────────────────
    // Users manage their own notification read state
    match /user_reads/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ── BUG REPORTS ────────────────────────────────────────────────────────
    // Authenticated users can submit; admins can read and update status
    match /bugs/{docId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth != null &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
